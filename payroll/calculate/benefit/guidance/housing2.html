
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Response received from the employer for housing and Utilities benefit questionnaire – ECA Review</title>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="noindex, follow" name="robots"/>
<!-- WET Assets -->
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/soyutils.js"></script>
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/wet-en.js"></script>
<link href="https://test.canada.ca/covid-19-guidance/proto/css/alpha-beta-banner.css" rel="stylesheet"/>
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/m%C3%A9li-m%C3%A9lo/2023-10-mount-revelstoke.min.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" rel="stylesheet">
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css" rel="stylesheet"/>


  <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5TBZBZVVK8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5TBZBZVVK8');
    </script>

<!-- Utility framework -->
    <link rel="stylesheet" href="/gcds-utility.min.css" />

    <link rel="stylesheet" href="/styles/prism.css">
    <link rel="stylesheet" href="/styles/style.css">
    <script src="/scripts/code-showcase.js"></script>
    <script src="/scripts/code-copy.js"></script>
    <script src="/scripts/component-preview.js"></script>
    <script src="/scripts/general.js"></script>
    <link rel="icon" type="image/x-icon" sizes="96x96" href="/favicon.ico">

    <!-- GC Design System  Components-->
    <link rel="stylesheet" href="/components/dist/gcds/gcds.css">
    <script type="module" src="/components/dist/gcds/gcds.esm.js"></script>




<!-- Styles -->
<style>
   body {
     font-family: Arial, sans-serif;
     padding: 20px;
   }
   table {
     width: 100%;
     border-collapse: collapse;
     margin-top: 1em;
   }
   th, td {
     border: 1px solid #ccc;
     padding: 8px;
     vertical-align: top;
   }
   th {
     background-color: #f2f2f2;
   }
    pre {
     background: #f4f4f4;
     padding: 10px;
     border-radius: 5px;
   }
   .probability-bar {
     margin-top: 0.2em;
     background: #eee;
     border-radius: 5px;
     height: 30px;
     position: relative;
     width: 100%;
   }
   .probability-fill {
     height: 100%;
     border-radius: 5px;
     text-align: center;
     line-height: 30px;
     color: white;
     font-weight: Bold;
   }

details summary {
  font-weight: bold;
font-size: 1.17em; /* Equivalent to h3 */
}

details {
  margin-bottom: 1em;
  padding: 0.5em 0.5em;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
}

.td-wrapper {
  position: relative;
  min-height: 3em;
  padding-bottom: 1.5em;
  height: 100%;
}

.score-icon {
  position: absolute;
  bottom: 4px;
  right: 4px;
}
.score-pill {
  display: inline-block;
  padding: 0.3em 0.6em;
  border-radius: 999px;
  margin-right: 0.5em;
  font-size: 0.9em;
  font-weight: bold;
  color: white;
}

.probability-bar {
  display: flex;
  height: 30px;
  border-radius: 999px;
  overflow: hidden;
  margin-bottom: 1em;
}
.probability-bar div {
  height: 100%;
  text-align: center;
  line-height: 30px;
  color: white;
  font-size: 0.8em;
}

@media print {
  body * {
    visibility: hidden;
  }
  #summaryContent, #summaryContent * {
    visibility: visible;
  }
  #summaryContent {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
}
	
</style>
<script type="text/javascript">
   document.write(wet.builder.refTop({}));
</script>
</head>
<body class="experimental" typeof="WebPage" vocab="http://schema.org/">
<div id="def-top"></div>
<main class="container" property="mainContentOfPage" role="main">
<div class="gc-font-2019">
<h1>Response received from the employer for housing and Utilities benefit questionnaire – Employer Compliance Audit (ECA) Review<br/>
<small>Questionnaire to determine if the employer properly reported housing and utility taxable benefits or shareholder benefits</small>
</h1>

<p class="mrgn-tp-lg">Each case is unique and requires a thorough review of the facts.</p>
  
<h3>Select your case number</h3>

<p>To use this tool, you have to select the <strong>case reference number</strong> and the <strong>name of the person who completed the questionnaire</strong> on behalf of the employer for employee/shareholder (1). If <strong>more than one</strong> questionnaire was completed for the same case reference number, it will provide the appropriate number (X). </p>
<div id="caseSelectorContainer">
  <label for="caseSelector"></label>   <select id="caseSelector"></select>
</div>

<div id="summaryContent">

<div id="analysisHeadingContainer" class="row">
  <div class="col-12">
    <div id="analysisHeading"></div>
  <div id="analysisIntro"></div>
  </div>
</div>

	
<div id="content"></div>

</div></div>
<script>
   const sectionMap = {
    30: "Section 1 - Information about this audit",
    31: "Section 1 - Information about this audit",
    38: "Section 1 - Information about this audit",
    32: "Section 1 - Information about this audit",

   39:  "Section 2 - Employee or shareholder information", 
   40:  "Section 2 - Employee or shareholder information",  
    2: "Section 2 - Employee or shareholder information",
    4: "Section 2 - Employee or shareholder information",
    6: "Section 2 - Employee or shareholder information",
    5: "Section 2 - Employee or shareholder information",
  
   

     8: "Section 3 - Reporting information", 
	   106: "Section 3 - Reporting information", 
12: "Section 3 - Reporting information", 
 143: "Section 3 - Reporting information", 
 107: "Section 3 - Reporting information", 
 14: "Section 3 - Reporting information", 
 144: "Section 3 - Reporting information", 
 15: "Section 3 - Reporting information", 
 
	   

	    47: "Section 4 (1) - Housing and utilities benefit information",
	    48: "Section 4 (1) - Housing and utilities benefit information",
	    51: "Section 4 (1) - Housing and utilities benefit information",
	    52: "Section 4 (1) - Housing and utilities benefit information",
	    56: "Section 4 (1) - Housing and utilities benefit information",
	    54: "Section 4 (1) - Housing and utilities benefit information",
	    58: "Section 4 (1) - Housing and utilities benefit information",
	    59: "Section 4 (1) - Housing and utilities benefit information",
	    61: "Section 4 (1) - Housing and utilities benefit information",
	    62: "Section 4 (1) - Housing and utilities benefit information",
	  
	
 
   63: "4a (1) - Fair market value (FMV) of the housing benefit",
 64: "4a (1) - Fair market value (FMV) of the housing benefit",   
  129: "4a (1) - Fair market value (FMV) of the housing benefit",    
	   
  67: "4b (1) - Use and availability of the housing",     
 68: "4b (1) - Use and availability of the housing",   
 135: "4b (1) - Use and availability of the housing",  
  105: "4b (1) - Use and availability of the housing",     
  105: "4b (1) - Use and availability of the housing",    
  74: "4b (1) - Use and availability of the housing",    
	137: "4b (1) - Use and availability of the housing",    
	     76: "4b (1) - Use and availability of the housing",    
	     138: "4b (1) - Use and availability of the housing",    



	   
       104: "4c (1) - Reduction to the value of the housing benefit",      
       78: "4c (1) - Reduction to the value of the housing benefit",   
       134: "4c (1) - Reduction to the value of the housing benefit",   
	   
       72: "4d (1) - Special situations",   
       73: "4d (1) - Special situations",   
       103: "4d (1) - Special situations",   
       80: "4d (1) - Special situations",   
       81: "4d (1) - Special situations",   
       
    
 102: "4e (1) - Utilities provided with the housing benefit", 	   
 132: "4e (1) - Utilities provided with the housing benefit",    
 133: "4e (1) - Utilities provided with the housing benefit",    

    
127: "4f (1) - Additional housing and utilities benefit information",         
117: "4f (1) - Additional housing and utilities benefit information",
	   122: "4f (1) - Additional housing and utilities benefit information",

    
 102: "Section 5 - Other benefit information related to the housing or utilities", 
 82: "Section 5 - Other benefit information related to the housing or utilities",
 131: "Section 5 - Other benefit information related to the housing or utilities",  	   

 119: "Section 6 - Certification", 
 19: "Section 6 - Certification", 
  20: "Section 6 - Certification", 
     22: "Section 6 - Certification", 
     24: "Section 6 - Certification", 
     26: "Section 6 - Certification", 
    29: "Section 6 - Certification",
	 28: "Section 6 - Certification"    

   // Add more mappings as needed
 };



const excludedSections = new Set([
  "section 1 - general information",
  "section 2 - business information",	
  "section 2a - additional business information of the worker",
  "section 3 - payee (worker) information",
  "section 3 - payers (clients) information",
  "section 4 - contract or agreement information",	
 "section 5 - working relationship information", 	
  "section 5 - certification"
]);

const sectionQuestionExclusions = {

// trying to remove this as it is not working
};
	
let workerData = null;
let payerData = null;


function handleSmartJsonUpload(file) {
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const jsonData = JSON.parse(e.target.result);
     
	workerCases = new Map();
	payerCases = new Map();


      jsonData.forEach(entry => {
        const q39 = entry.answers.find(a => a.questionId === 39);
        const caseAns = entry.answers.find(a => a.questionId === 31);
        const caseNumber = caseAns && caseAns.answer ? caseAns.answer.trim() : "Unknown";

        if (q39 && q39.answer.includes("Your employee")) {
          workerCases.set(caseNumber, entry);
        } else if (q39 && q39.answer.includes("Payer who made payments")) {
          payerCases.set(caseNumber, entry);
        }
      });

      const workerKeys = [...workerCases.keys()];
      const payerKeys = [...payerCases.keys()];
      const allKeys = [...new Set([...workerKeys, ...payerKeys])];


if (workerKeys.length > 0 || payerKeys.length > 0) {
  handleCaseSelection(workerCases, payerCases);
} else {
  alert("Could not determine if the file is for a worker or payer.");
}


    } catch (err) {
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
}



function tryRenderBoth() {
  if (!workerData && !payerData) return;

  const workerCases = workerData ? extractCaseNumbers(workerData) : new Map();
  const payerCases = payerData ? extractCaseNumbers(payerData) : new Map();

  handleCaseSelection(workerCases, payerCases);
}

function extractCaseNumbers(data) {
  const cases = new Map(); // Map of caseNumber -> entry
  data.forEach(entry => {
    const caseAns = entry.answers.find(a => a.questionId === 31);
    if (caseAns && caseAns.answer) {
      cases.set(caseAns.answer.trim(), entry);
    }
  });
  return cases;
}


  document.addEventListener('DOMContentLoaded', function () {
    const percentFields = ['61', '13502'];
    const dollarFields = [
      '12905', '13102', '13302', '13303',
      '13304', '13305', '13306', '13307'
    ];

    function updateField(id, type) {
      const input = document.getElementById(id);
      if (input) {
        if (type === 'percent' && !input.value.endsWith('%')) {
          input.value += '%';
        } else if (type === 'dollar' && !input.value.startsWith('$')) {
          input.value = '$' + input.value;
        }
      }
    }

    function tryUpdateFields() {
      percentFields.forEach(id => updateField(id, 'percent'));
      dollarFields.forEach(id => updateField(id, 'dollar'));
    }

    // Retry every 500ms for up to 10 seconds
    let attempts = 0;
    const maxAttempts = 20;
    const interval = setInterval(() => {
      tryUpdateFields();
      attempts++;
      if (attempts >= maxAttempts) {
        clearInterval(interval);
      }
    }, 500);
  });
 

function updateCaseSelector(caseNumbers) {
  console.log("Updating dropdown with cases:", caseNumbers);
  const dropdown = document.getElementById("caseSelector");
  dropdown.innerHTML = "";

  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "Make your selection...";
  defaultOption.disabled = true;
  defaultOption.selected = true;
  dropdown.appendChild(defaultOption);

  caseNumbers.forEach(cn => {
    const option = document.createElement("option");
    option.value = cn;

    let label = cn;
    const hasWorker = workerCases.has(cn);
    const hasPayer = payerCases.has(cn);

    if (hasWorker && hasPayer) label += " (2)";
    else if (hasWorker) label += " (1)";
    else if (hasPayer) label += " (1)";

    const entry = workerCases.get(cn) || payerCases.get(cn);
    const nameAnswer = entry?.answers.find(a => a.questionId === 22);
    const idAnswer = entry?.answers.find(a => a.questionId === 24);
    const name = nameAnswer ? nameAnswer.answer : "";
    const id = idAnswer ? idAnswer.answer : "";

    if (name || id) {
      label += ` - ${[id, name].filter(Boolean).join(" ")}`;
    }

    option.textContent = label;
    dropdown.appendChild(option);
  });

  document.getElementById("caseSelectorContainer").style.setProperty("display", "block", "important");

  // Select and trigger change only if one case
  if (caseNumbers.length === 1) {
    dropdown.selectedIndex = 1;
    dropdown.dispatchEvent(new Event("change"));
  }
}

function handleCaseSelection(workerCases, payerCases) {
  const workerKeys = [...workerCases.keys()];
  const payerKeys = [...payerCases.keys()];
  const allKeys = [...new Set([...workerKeys, ...payerKeys])];
  const matching = workerKeys.filter(k => payerCases.has(k));

  const dropdown = document.getElementById("caseSelector");

  // ✅ Set the event handler BEFORE any selection logic
  dropdown.onchange = () => {
    if (dropdown.value) {
      renderSelectedCase(workerCases, payerCases, dropdown.value);
      document.getElementById("step2").style.display = "block";
    }
  };

  // ✅ Multiple matching cases
 if (allKeys.length > 1) {
  updateCaseSelector(allKeys);
}


  // ✅ Exactly one matching case
  else if (matching.length === 1) {
    document.getElementById("caseSelectorContainer").style.display = "none";
    renderSelectedCase(workerCases, payerCases, matching[0]);
  }

  // ✅ Only one case total (worker or payer)
  else if (allKeys.length === 1) {
    console.log("Only one case found, showing dropdown.");
    updateCaseSelector(allKeys);

    setTimeout(() => {
      const dropdown = document.getElementById("caseSelector");
      if (!dropdown) {
        console.error("Dropdown not found!");
        return;
      }

      console.log("Dropdown options:", [...dropdown.options].map(opt => opt.textContent));
      dropdown.value = allKeys[0]; // Select by value
      dropdown.dispatchEvent(new Event("change"));
    }, 50);
  }

  // ✅ Multiple cases but no match — show all
  else if (allKeys.length > 1) {
    updateCaseSelector(allKeys);
  }
}


function renderSelectedCase(workerCases, payerCases, caseNumber) {
  const container = document.getElementById("content");
  container.innerHTML = "";

  const workerEntry = workerCases.get(caseNumber);
  const payerEntry = payerCases.get(caseNumber);

  if (workerEntry && payerEntry) {
    container.appendChild(renderJSON([workerEntry], [payerEntry]));
    renderProbabilityScore([workerEntry], [payerEntry]);
  } else if (workerEntry) {
    container.appendChild(renderJSON([workerEntry], []));
    renderProbabilityScore([workerEntry], []);
  } else if (payerEntry) {
    container.appendChild(renderJSON([], [payerEntry]));
    renderProbabilityScore([], [payerEntry]);
  }
}

	
function renderJSON(workerData, payerData) {
  const showWorker = workerData.length > 0;
  const showPayer = payerData.length > 0;

   const sectioned = {};

   function addToSection(ans, isPayer = false) {
    const section = sectionMap[ans.questionId] || "Other";
    if (!sectioned[section]) sectioned[section] = {};
    if (!sectioned[section][ans.questionEn]) {
      sectioned[section][ans.questionEn] = {
        worker: "", payer: "", rawWorker: "", rawPayer: ""
      };
    }
    const formatted = formatAnswer(ans.answer);
    
const raw = typeof ans.answer === 'string' ? normalizeAnswer(ans.answer) : JSON.stringify(ans.answer);
  
    if (isPayer) {
      sectioned[section][ans.questionEn].payer = formatted;
      sectioned[section][ans.questionEn].rawPayer = raw;
    } else {
      sectioned[section][ans.questionEn].worker = formatted;
      sectioned[section][ans.questionEn].rawWorker = raw;
    }
  }

function formatAnswer(answer) {
  if (Array.isArray(answer)) {
    return answer.map((group, index) => {
      const table = document.createElement("table");
      table.innerHTML = `<thead><tr><th colspan="2">Year #${index + 1}</th></tr><tr><th>Question</th><th>Answer</th></tr></thead>`;
      const tbody = document.createElement("tbody");

      group.forEach(sub => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${sub.questionEn}</td><td>${sub.answer}</td>`;
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      return table.outerHTML;
    }).join("<br><br>");
  }

  return answer || "";
}

	 const skipMismatchHighlighting = [
  "Section 1 - Information about this audit",
  "Section 2 - Employee or shareholder information",
  "Section 3 - Reporting information",		 
  "Section 4 (1) - Housing and utilities benefit information",
  "4a (1) - Fair market value (FMV) of the housing benefit",
  "4b (1) - Use and availability of the housing",
"4b (1) - Use and availability of the housing",
		 "4c (1) - Reduction to the value of the housing benefit",
		 "4d (1) - Special situations",
		 "4e (1) - Utilities provided with the housing benefit",
		 "Section 5 - Other benefit information related to the housing or utilities",
  "Section 6 - Certification"
      
];

 

  workerData.forEach(entry => entry.answers.forEach(ans => addToSection(ans, false)));
  payerData.forEach(entry => entry.answers.forEach(ans => addToSection(ans, true)));
  const container = document.createElement('div');

for (const [section, questions] of Object.entries(sectioned)) {
  const table = document.createElement('table');

let showWorker = workerData.length > 0;
let showPayer = payerData.length > 0;

// Special rules for column visibility
if (section === "Section 1 - General information" && showWorker && showPayer) {
  showPayer = false;
}
if (section === "Section 2a - Additional business information of the worker" && showWorker && showPayer) {
  showPayer = false;
}
if (section === "Section 3 - Payers (clients) information" && showWorker && showPayer) {
  showPayer = false;
}
if (section === "Section 3 - Payee (worker) information" && showWorker && showPayer) {
  showWorker = false;
}


   if (!showWorker && !showPayer) continue;

let theadHTML = '<thead><tr><th style="white-space: nowrap;">Question</th>';
if (showWorker) {
 const label = (section === "Section 1 - General information" && workerData.length > 0 && payerData.length > 0) ? "Answer" : "&nbsp;Employee/shareholder #1&nbsp;&nbsp;";

  theadHTML += `<th style="white-space: nowrap;">${label}</th>`;
}
if (showPayer) theadHTML += '<th style="white-space: nowrap;">&nbsp;Employee/shareholder #2&nbsp;&nbsp;</th>';
theadHTML += '</tr></thead>';


	
  table.innerHTML = theadHTML;

  const tbody = document.createElement('tbody');
  let rowCount = 0;

  for (const [question, data] of Object.entries(questions)) {
    const { worker, payer, rawWorker, rawPayer } = data;
    if (!worker && !payer) continue;

    const isMismatch = !skipMismatchHighlighting.includes(section) &&
      rawWorker && rawPayer && rawWorker !== rawPayer;

const isExcluded = excludedSections.has(normalize(section));

	  
    const row = document.createElement('tr');
    let rowHTML = `<td>${question}</td>`;
  if (showWorker) {
const workerIcon = isExcluded ? '' : getScoreIcon(
  Object.keys(sectionMap).find(id =>
    sectionMap[id] === section &&
    workerData.some(d => d.answers.some(a => a.questionEn === question && a.questionId == id))
  ),
  data.rawWorker
);
rowHTML += `<td style="${isMismatch ? 'background-color: #fff3cd;' : ''}; position: relative;">
<div class="td-wrapper">
  <div style="margin-bottom: 1.5em;">${worker}</div>
  ${workerIcon}
</div>
</td>`;

}

if (showPayer) {
  const payerIcon = isExcluded ? '' : getScoreIcon(
  Object.keys(sectionMap).find(id =>
    sectionMap[id] === section &&
    payerData.some(d => d.answers.some(a => a.questionEn === question && a.questionId == id))
  ),
  data.rawPayer
);

rowHTML += `<td style="${isMismatch ? 'background-color: #fff3cd;' : ''}; position: relative;">
 <div class="td-wrapper">
  <div style="margin-bottom: 1.5em;">${payer}</div>
  ${payerIcon}
</div>
</td>`;


}

    row.innerHTML = rowHTML;
    tbody.appendChild(row);
    rowCount++;
  }

  if (rowCount > 0) {
    const shouldCollapse = [
      "Section 1 - Information about this audit",
      
      "Section 6 - Certification"
    ].includes(section);

    if (shouldCollapse) {
   const details = document.createElement('details');
// details.setAttribute('open', ''); // Collapse by default
   const summary = document.createElement('summary');
      summary.textContent = section;
      details.appendChild(summary);
      table.appendChild(tbody);
      details.appendChild(table);
      container.appendChild(details);
    } else {
      const sectionHeader = document.createElement('h3');
      sectionHeader.textContent = section;
      container.appendChild(sectionHeader);
      table.appendChild(tbody);
      container.appendChild(table);
    }
  }
}



  return container;
}

function normalize(section) {
  return (section || "")
   .trim()
.toLowerCase()
.replace(/[’‘]/g, "'")
.replace(/[\u2013\u2014\u2012\u2010]/g, '-')
.replace(/\s+/g, ' ')
.replace(/[^a-z0-9\s'/-]/g, ''); // strip unexpected punctuation
}

</script>
<!-- Probability bar container -->
<div id="probability" style="margin-top: 2em;"></div>
<!-- WET PreFooter -->
</div></main>


<script>

function normalizeAnswer(answer) {
return String(answer || "")
.trim()
.toLowerCase()
.replace(/[’‘]/g, "'")
.replace(/[\u2013\u2014\u2012\u2010]/g, '-')
.replace(/\s+/g, ' ')
.replace(/[^a-z0-9\s'/-]/g, ''); // strip unexpected punctuation
}


const customScoringRules = {
   
  39: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
	   case "your employee": return 1; // Employee
      case "a shareholder": return -1; // Shareholder
     case "a shareholder who is also your employee": return 0;  // PSB    
    }
  },
 
};


function scoreAnswer(answer, questionId) {
  const rule = customScoringRules[questionId];
  if (rule) return rule(answer);
  return -2; // Default to information documents if no rule found
}

function getScoreIcon(questionId, answer) {
  const score = scoreAnswer(answer, questionId);
  let icon = '';
  let color = '';
  let title = '';

  if (score === 1) {
    icon = 'fas fa-users';
    color = 'green';
    title = 'Employee';
  } else if (score === -1) {
    icon = 'fas fa-user-tie';
    color = '#004085';
    title = 'Shareholder';
  } else if (score === 0) {
    icon = 'fas fa-user-tie';
    color = 'grey';
    title = 'Shareholder who is also your employee';
  }
 else if (score === -2) {
    icon = '';
    color = '#a2bffe';
    title = 'Information to help with the contract review';
  }	

  if (icon) {
    return `
      <div class="score-icon">
        <i class="fas ${icon}" style="color: ${color};" title="${title}"></i>
      </div>`;
  }

  return '';
}
	
	
</script>

<script>
function normalize(section) {
return (section || "").trim().toLowerCase();
}
	
function calculateSectionScores(data) {
  const totalsScores = {}, cosScores = {}, cfsScores = {}, neutralsScores = {}, infoScores = {}; 

  data.forEach(entry => {
    entry.answers.forEach(ans => {
      const section = sectionMap[ans.questionId] || "Other";
      const normalizedSection = normalize(section);
      const exclusions = sectionQuestionExclusions[section] || [];

      if (!excludedSections.has(normalizedSection)) {
        if (!totalsScores[section]) {
          totalsScores[section] = 0;
 	  cosScores[section] = 0;
          cfsScores[section] = 0;
 	  neutralsScores[section] = 0;
          infoScores[section] = 0;	
        }

        if (ans.answer && ans.answer !== "") {
          totalsScores[section]++;
          if (!exclusions.includes(ans.questionId)) {
            const score = scoreAnswer(ans.answer, ans.questionId);
	  console.log("QID:", ans.questionId, "Answer:", ans.answer, "Score:", score, "Section:", section);

            if (score === 1) cosScores[section]++;
            else if (score === -1) cfsScores[section]++;
	    else if (score === 0) neutralsScores[section]++;
	    else if (score === -2) infoScores[section]++;	  
	  }
        }
      }
    });
  });

  return {totalsScores, cosScores, cfsScores, neutralsScores, infoScores};
}

function getIndicatorIcon(score) {
  if (score === 1) {
    return `<i class="fas fa-users" style="color: green;" title="Contract of service"></i>`;
  } 
   else if (score === -1) {
    return `<i class="fas fa-user-tie" style="color: #004085;" title="Contract for services"></i>`;
 }	  
  else if (score === 0) {
    return `<i class="fas fa-not-equal" style="color: grey;" title="Neutral"></i>`;	  
  } 
  else if (score === -2) {
    return `<i class="fas fa-book" style="color: #a2bffe;" title="Information to help with the contract review"></i>`;
  }
}

function generateDistributionBar(cos, cfs, neutral, info, total) {
  const cosPercent = total ? (cos / total * 100).toFixed(1) : 0;
  const cfsPercent = total ? (cfs / total * 100).toFixed(1) : 0;
  const neutralPercent = total ? (neutral / total * 100).toFixed(1) : 0;
  const infoPercent = total ? (info / total * 100).toFixed(1) : 0;	

  return `
    <div class="probability-bar">
      <div style="width:${cosPercent}%; background: green;">${cos > 0 ? cosPercent + "%" : ""}</div>
      <div style="width:${cfsPercent}%; background: #004085;">${cfs > 0 ? cfsPercent + "%" : ""}</div>
      <div style="width:${neutralPercent}%; background: gray;">${neutral > 0 ? neutralPercent + "%" : ""}</div>
       <div style="width:${infoPercent}%; background: #a2bffe;">${info > 0 ? infoPercent + "%" : ""}</div>
    </div>
  `;
}	
	


function renderProbabilityScore(workerData, payerData) {
  const probabilityDiv = document.getElementById('probability');

  // Inject heading into full-width container above the row
const headingContainer = document.getElementById('analysisHeading');
if (headingContainer) {
  headingContainer.innerHTML = ''; // Clear previous content

  // Create and insert the <h2> heading
  let headingText = '';
  if (workerData.length > 0 && payerData.length > 0) {
    headingText = "Worker's and payer's answers – Begin your full analysis using each factor";
  } else if (workerData.length > 0) {
    headingText = "Worker's answers – Begin your analysis using each factor";
  } else if (payerData.length > 0) {
    headingText = "Payer's answers – Begin your analysis using each factor";
  }

  if (headingText) {
    const heading = document.createElement('h2');
    heading.textContent = headingText;
    heading.classList.add('mt-4', 'mb-3');
    headingContainer.appendChild(heading);
  }

  // Remove any previous introDetails if it exists
  const existingDetails = document.getElementById('introDetails');
  if (existingDetails) existingDetails.remove();

  // Create <details> container
  const details = document.createElement('details');
  details.id = 'introDetails';
  details.open = true;

  // Create <summary>
  const summary = document.createElement('summary');
  summary.innerHTML = '<strong>About this summary</strong>';
  details.appendChild(summary);

  // Create content container
  const introContainer = document.createElement('div');
  introContainer.id = 'analysisIntro';
  introContainer.innerHTML = `
    <p>The questionnaire uses the following icons to categorize the answers received:</p>
    <ul class="list-unstyled">
      <li class="mrgn-lft-lg"><i class="fas fa-users" style="color: green;" title="Contract of service"></i> Contract of service (employment)</li>
      <li class="mrgn-lft-lg"><i class="fas fa-user-tie" style="color: #004085;" title="Contract for services"></i> Contract for services (self-employed worker)</li>
      <li class="mrgn-lft-lg"><i class="fas fa-not-equal" style="color: grey;" title="Neutral"></i> Neutral</li>
      <li class="mrgn-lft-lg"><i class="fas fa-book" style="color: #a2bffe;" title="Information to help with the contract review"></i> Information to help with the contract review</li>
    </ul>
    <p class="mrgn-tp-md">These categorizations are <strong>generally</strong> accurate for the indicators reviewed. However, depending on the facts of this review, these icons may not always apply. To make a final decision, you need to review <strong>all</strong> indicators together, along with the documents sent by both the payer and the worker.</p>
  `;

  // Add mismatch note if both sets of answers are present
  if (workerData.length > 0 && payerData.length > 0) {
    const mismatchNote = document.createElement('p');
    mismatchNote.classList.add('mrgn-tp-md');
    mismatchNote.innerHTML = `To help you quickly spot mismatches between the 2 answers, if the worker and payer answers are different, the cells will be highlighted in <span style="background-color: #fff3cd;">yellow</span>.`;
    introContainer.appendChild(mismatchNote);
  }

  // Append content and details to heading container
  details.appendChild(introContainer);
  headingContainer.appendChild(details);


}
</script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // Only fetch remote JSON if no file has been uploaded
  if (!window.workerCases && !window.payerCases) {
    fetch('https://test.canada.ca/cra-arc/payroll/calculate/benefit/guidance/RES_housing.json')
      .then(response => {
        if (!response.ok) throw new Error('Failed to load JSON');
        return response.json();
      })
      .then(jsonData => {
        const workerMap = new Map();
        const payerMap = new Map();
        jsonData.forEach(entry => {
          const q39 = entry.answers.find(a => a.questionId === 39);
          const caseAns = entry.answers.find(a => a.questionId === 31);
          const caseNumber = caseAns && caseAns.answer ? caseAns.answer.trim() : "Unknown";
          if (q39 && q39.answer.includes("Your employee")) {
            workerMap.set(caseNumber, entry);
          } else if (q39 && q39.answer.includes("A shareholder who is also your employee")) {
            payerMap.set(caseNumber, entry);
          }
        });
        window.workerCases = workerMap;
        window.payerCases = payerMap;
        handleCaseSelection(workerMap, payerMap);
      })
      .catch(error => {
        console.error('Error loading JSON:', error);
      });
  }
});
</script>


 


<script>
function printSummary() {
  // Expand all <details> elements
  document.querySelectorAll("details").forEach(detail => {
    detail.setAttribute("open", true);
  });

  // Wait a moment to ensure rendering, then print
  setTimeout(() => {
    window.print();
  }, 100);
}
</script>



</body>
</html>
