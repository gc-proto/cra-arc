<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Worker vs. payer questionnaire comparison - Questionnaire to determine if the worker's corporation was carrying on a personal services business (PSB)</title>
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta name="robots" content="noindex, follow">
<!-- WET Assets -->
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/soyutils.js"></script>
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/wet-en.js"></script>
<link href="https://test.canada.ca/covid-19-guidance/proto/css/alpha-beta-banner.css" rel="stylesheet">
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/m%C3%A9li-m%C3%A9lo/2023-10-mount-revelstoke.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"/>
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css" rel="stylesheet">

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Styles -->
<style>
 body {
   font-family: Arial, sans-serif;
   max-width: 900px;
   margin: 40px auto;
   padding: 0 20px;
 }
 h1 {
   text-align: center;
 }
 #uploadContainer {
   text-align: center;
   margin-bottom: 25px;
 }
 input[type="file"] {
   font-size: 16px;
 }
 table {
   border-collapse: collapse;
   width: 100%;
   margin: 20px 0;
 }
 th, td {
   border: 1px solid #aaa;
   padding: 8px 12px;
   text-align: center;
 }
 th {
   background-color: #eee;
 }
 .respondent-bar {
   margin: 15px 0;
 }
 .scaleContainer {
   width: 100%;
   background: #eee;
   height: 25px;
   border-radius: 5px;
   overflow: hidden;
   position: relative;
 }
 .scaleBar {
   height: 100%;
   border-radius: 5px;
   transition: width 0.5s ease;
   background: linear-gradient(to right, red, orange, yellow, green);
 }
 .scoreLabel {
   font-weight: bold;
   margin-top: 6px;
   text-align: center;
 }
 #exportButtons {
   text-align: center;
   margin-top: 30px;
 }
 button {
   font-size: 16px;
   margin: 0 8px;
   padding: 8px 16px;
   cursor: pointer;
 }
 #sectionFilter {
   margin-bottom: 15px;
 }
</style>
<script type="text/javascript">
   document.write(wet.builder.refTop({}));
</script>
</head>
<body vocab="http://schema.org/" typeof="WebPage" class="experimental">
<div id="def-top"></div>
<main role="main" property="mainContentOfPage" class="container">
<div class="gc-font-2019">
<h1>Worker vs. payer questionnaire comparison <br>
<small>Questionnaire to determine if the worker's corporation was carrying on a personal services business (PSB)</small></h1>
  <p>To use the comparison tool:</p>
<ol>
<li>Save the file worker and the file payer on your computer</li>
<li>Upload the response files (JSON) for the worker and the payer</li>
<li>Click compare to view side-by-side results (if the results do not match, they are highlighted)</li>
</ol>
<hr> 
<div id="uploadContainer">
<label for="fileInput">Upload JSON or CSV:</label><br/>
<input type="file" id="fileInput" accept=".json,.csv" />
</div>
  
<div id="sectionFilter" style="display:none;">
<label for="sectionSelect">Filter by Section:</label>
<select id="sectionSelect">
<option value="all">All Sections</option>
</select>
</div>
<div id="resultsContainer">
<!-- Tables and bars will appear here -->
</div>
<div id="exportButtons" style="display:none;">
<button id="exportPDF">Export as PDF</button>
<button id="exportPNG">Export as PNG</button>
</div>
<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
 const fileInput = document.getElementById('fileInput');
 const resultsContainer = document.getElementById('resultsContainer');
 const exportButtons = document.getElementById('exportButtons');
 const sectionFilter = document.getElementById('sectionFilter');
 const sectionSelect = document.getElementById('sectionSelect');
 let rawData = null;
 let groupedBySection = false;
 let currentSection = 'all';
 // Scoring rules - customize here
 const scoringRules = {
   yes: 1,
   true: 1,
   '1': 1,
   sometimes: 0.5,
   maybe: 0.5,
   partial: 0.5,
   no: 0,
   false: 0,
   '0': 0
 };
 // Risk categories thresholds
 function getRiskLabel(scorePercent) {
   if (scorePercent >= 80) return 'Highly Probable';
   if (scorePercent >= 60) return 'Probable';
   if (scorePercent >= 40) return 'Uncertain';
   if (scorePercent >= 20) return 'Unlikely';
   return 'Highly Unlikely';
 }
 // Score a single answer string
 function getScore(answer) {
   if (!answer) return 0;
   const a = answer.toString().toLowerCase().trim();
   return scoringRules[a] !== undefined ? scoringRules[a] : 0;
 }
 // Escape HTML to avoid injection
 function escapeHtml(text) {
   if (!text) return '';
   return text.toString()
     .replace(/&/g, "&amp;")
     .replace(/</g, "&lt;")
     .replace(/>/g, "&gt;")
     .replace(/"/g, "&quot;")
     .replace(/'/g, "&#039;");
 }
 // Parse JSON or CSV, then render
 fileInput.addEventListener('change', (e) => {
   const file = e.target.files[0];
   if (!file) return;
   const ext = file.name.split('.').pop().toLowerCase();
   const reader = new FileReader();
   reader.onload = (event) => {
     try {
       if (ext === 'json') {
         rawData = JSON.parse(event.target.result);
         if (!Array.isArray(rawData)) {
           alert("JSON should be an array of respondent objects.");
           rawData = null;
           return;
         }
         processData(rawData);
       } else if (ext === 'csv') {
         Papa.parse(event.target.result, {
           header: true,
           skipEmptyLines: true,
           complete: function(results) {
             rawData = results.data;
             processData(rawData);
           }
         });
       } else {
         alert("Unsupported file type. Upload JSON or CSV.");
       }
     } catch (err) {
       alert("Error reading file: " + err.message);
     }
   };
   reader.readAsText(file);
 });
 // Process raw data, detect sections and render dashboard
 function processData(data) {
   resultsContainer.innerHTML = '';
   exportButtons.style.display = 'none';
   sectionFilter.style.display = 'none';
   currentSection = 'all';
   // Detect section grouping if keys have underscore, e.g. section1_q1
   groupedBySection = false;
   if(data.length > 0) {
     const sampleKeys = Object.keys(data[0]);
     groupedBySection = sampleKeys.some(k => k.includes('_'));
   }
   // Build section list if grouped
   if (groupedBySection) {
     const sectionSet = new Set();
     Object.keys(data[0]).forEach(key => {
       const parts = key.split('_');
       if (parts.length > 1) sectionSet.add(parts[0]);
     });
     if (sectionSet.size > 0) {
       sectionFilter.style.display = 'block';
       sectionSelect.innerHTML = `<option value="all">All Sections</option>`;
       [...sectionSet].sort().forEach(s => {
         sectionSelect.innerHTML += `<option value="${s}">${s}</option>`;
       });
     }
   }
   renderDashboard(data);
   exportButtons.style.display = 'block';
 }
 // When user changes section filter
 sectionSelect.addEventListener('change', (e) => {
   currentSection = e.target.value;
   if(rawData) {
     renderDashboard(rawData);
   }
 });
 // Render entire dashboard
 function renderDashboard(data) {
   resultsContainer.innerHTML = '';
   // Show answers table filtered by section if grouped
   renderTable(data);
   // Show probability bars for each respondent
   data.forEach((resp, idx) => {
     renderRespondentBar(resp, idx + 1);
   });
 }
 // Render table of all answers, filtered by section if needed
 function renderTable(data) {
   if (data.length === 0) {
     resultsContainer.innerHTML = "<p>No data to display.</p>";
     return;
   }
   // Filter keys by currentSection
   let keys = Object.keys(data[0]);
   if (groupedBySection && currentSection !== 'all') {
     keys = keys.filter(k => k.startsWith(currentSection + '_'));
     if(keys.length === 0) {
       resultsContainer.innerHTML = "<p>No data for selected section.</p>";
       return;
     }
   }
   let html = '<table><thead><tr><th>Respondent #</th>';
   keys.forEach(k => html += `<th>${escapeHtml(k)}</th>`);
   html += '</tr></thead><tbody>';
   data.forEach((resp, idx) => {
     html += `<tr><td>${idx + 1}</td>`;
     keys.forEach(k => {
       html += `<td>${escapeHtml(resp[k] || '')}</td>`;
     });
     html += '</tr>';
   });
   html += '</tbody></table>';
   resultsContainer.innerHTML += html;
 }
 // Render one respondent's probability bar
 function renderRespondentBar(resp, number) {
   let keys = Object.keys(resp);
   if (groupedBySection && currentSection !== 'all') {
     keys = keys.filter(k => k.startsWith(currentSection + '_'));
   }
   const answers = keys.map(k => resp[k]);
   const total = answers.length;
   const score = answers.reduce((sum, a) => sum + getScore(a), 0);
   const percent = total > 0 ? Math.round((score / total) * 100) : 0;
   const label = getRiskLabel(percent);
   const container = document.createElement('div');
   container.className = 'respondent-bar';
   
  const title = document.createElement('div');
   title.textContent = `Respondent #${number} - Risk Score: ${percent}% (${label})`;
   title.style.fontWeight = 'bold';
   container.appendChild(title);
   const scaleContainer = document.createElement('div');
   scaleContainer.className = 'scaleContainer';
   const scaleBar = document.createElement('div');
   scaleBar.className = 'scaleBar';
   scaleBar.style.width = percent + '%';
   scaleBar.title = label;
   scaleContainer.appendChild(scaleBar);
   container.appendChild(scaleContainer);
   resultsContainer.appendChild(container);
 }
 // Export dashboard to PDF
 document.getElementById('exportPDF').addEventListener('click', () => {
   const { jsPDF } = window.jspdf;
   const doc = new jsPDF('p', 'pt', 'a4');
   const content = resultsContainer;
   html2canvas(content, {scale: 2}).then(canvas => {
     const imgData = canvas.toDataURL('image/png');
     const imgProps = doc.getImageProperties(imgData);
     const pdfWidth = doc.internal.pageSize.getWidth();
     const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
     doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
     doc.save('questionnaire_dashboard.pdf');
   });
 });
 // Export dashboard to PNG
 document.getElementById('exportPNG').addEventListener('click', () => {
   html2canvas(resultsContainer, {scale: 3}).then(canvas => {
     const link = document.createElement('a');
     link.download = 'questionnaire_dashboard.png';
     link.href = canvas.toDataURL();
     link.click();
   });
 });
</script>

</div>
</body>
</html>
