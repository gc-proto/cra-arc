<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Worker vs. payer questionnaire comparison - PSB Determination</title>
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta name="robots" content="noindex, follow">
<!-- WET Assets -->
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/soyutils.js"></script>
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/wet-en.js"></script>
<link href="https://test.canada.ca/covid-19-guidance/proto/css/alpha-beta-banner.css" rel="stylesheet">
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/m%C3%A9li-m%C3%A9lo/2023-10-mount-revelstoke.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" crossorigin="anonymous"/>
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css" rel="stylesheet">
<!-- Styles -->
<style>
   body {
     font-family: Arial, sans-serif;
     padding: 20px;
   }
   table {
     width: 100%;
     border-collapse: collapse;
     margin-top: 1em;
   }
   th, td {
     border: 1px solid #ccc;
     padding: 8px;
     vertical-align: top;
   }
   th {
     background-color: #f2f2f2;
   }
    pre {
     background: #f4f4f4;
     padding: 10px;
     border-radius: 5px;
   }
   .probability-bar {
     margin-top: 2em;
     background: #eee;
     border-radius: 5px;
     height: 30px;
     position: relative;
     width: 100%;
   }
   .probability-fill {
     height: 100%;
     border-radius: 5px;
     text-align: center;
     line-height: 30px;
     color: white;
     font-weight: bold;
   }
</style>
<script type="text/javascript">
   document.write(wet.builder.refTop({}));
</script>
</head>
<body vocab="http://schema.org/" typeof="WebPage" class="experimental">
<div id="def-top"></div>
<main role="main" property="mainContentOfPage" class="container">
<div class="gc-font-2019">
<h1>Worker vs. payer questionnaire comparison<br>
<small>Questionnaire to determine if the worker's corporation was carrying on a personal services business (PSB)</small>
</h1>
<p>To use the comparison tool:</p>
<ol>
<li>Save the worker and payer JSON files on your computer.</li>
<li>Upload both files below.</li>
<li>Click compare to view side-by-side results and risk score.</li>
</ol>
<h3>Upload the response files (JSON)</h3>
<ul class="list-unstyled cnjnctn-type-and cnjnctn-sm">
<li class="cnjnctn-col">
<label>Worker's response:
<input type="file" id="jsonWorkerInput" accept=".json" />
</label>
</li>
<li class="cnjnctn-col">
<label>Payer's response:
<input type="file" id="jsonPayerInput" accept=".json" />
</label>
</li>
</ul>
<div class="row">
  <div class="col-md-9">
<div id="content"></div>
</div>
   <div class="col-md-3">   
<div id="probability"></div>
</div>
</div>

<script>
const sectionMap = {
  340: "Section 1: General information", 
  341: "Section 1: General information",
  335: "Section 1: General information",
  161: "Section 1: General information",
  240: "Section 1: General information",
  241: "Section 1: General information",
  243: "Section 1: General information",
  441: "Section 2: Information about the business", 
  443: "Section 2: Information about the business",  
  315: "Section 2: Information about the business",
  318: "Section 2: Information about the business",
  319: "Section 2: Information about the business",
  317: "Section 2: Information about the business",
  320: "Section 2: Information about the business", 
  321: "Section 2: Information about the business",
  322: "Section 2: Information about the business",
  323: "Section 2: Information about the business",
  324: "Section 2: Information about the business",
  325: "Section 2: Information about the business",
  326: "Section 2: Information about the business", 
  327: "Section 2: Information about the business",
  328: "Section 2: Information about the business",
  329: "Section 2: Information about the business",
  330: "Section 2: Information about the business",
  331: "Section 2: Information about the business", 
  332: "Section 2: Information about the business",
  333: "Section 2: Information about the business",
  334: "Section 2: Information about the business",
  316: "Section 2: Information about the business",
  339: "Worker - Section 2a - Employee information",
  170: "Worker - Section 2a - Employee information",
  356: "Worker - Section 2a - Employee information",   
  464: "Worker - Section 2a - Employee information",      
  342: "Worker - Section 2b - Specified shareholder information",     
  245: "Worker - Section 2b - Specified shareholder information",   
  352: "Worker - Section 2b - Specified shareholder information",  
  465: "Worker - Section 2b - Specified shareholder information",     
  444: "Payer - Section 3 - Payee (worker) information",   
  445: "Payer - Section 3 - Payee (worker) information",   
  446: "Payer - Section 3 - Payee (worker) information",   
  447: "Payer - Section 3 - Payee (worker) information",   
  448: "Payer - Section 3 - Payee (worker) information",   
  449: "Payer - Section 3 - Payee (worker) information",   
  450: "Payer - Section 3 - Payee (worker) information",   
  451: "Payer - Section 3 - Payee (worker) information",   
  452: "Payer - Section 3 - Payee (worker) information",   
  358: "Worker - Section 3 - Payers (clients) information",  
  314: "Worker - Section 3 - Payers (clients) information",   
  31401: "Worker - Section 3 - Payers (clients) information",   
  31407: "Worker - Section 3 - Payers (clients) information",   
  31402: "Worker - Section 3 - Payers (clients) information",
  31403: "Worker - Section 3 - Payers (clients) information",
  31404: "Worker - Section 3 - Payers (clients) information", 
  31405: "Worker - Section 3 - Payers (clients) information", 
  31410: "Worker - Section 3 - Payers (clients) information", 
  31411: "Worker - Section 3 - Payers (clients) information", 
  31412: "Worker - Section 3 - Payers (clients) information", 
  31406: "Worker - Section 3 - Payers (clients) information", 
  350: "Section 4 - Contract or agreement information",    
  236: "Section 4 - Contract or agreement information",    
  207: "Section 4 - Contract or agreement information",    
  206: "Section 4 - Contract or agreement information",   
  351: "Section 4 - Contract or agreement information",   
  379: "Section 4 - Contract or agreement information",  
  347: "Section 4 - Contract or agreement information", 
  348: "Section 4 - Contract or agreement information", 
  380: "Section 4 - Contract or agreement information", 
  382: "Section 4 - Contract or agreement information", 
  423: "Section 4 - Contract or agreement information", 
  349: "Section 4 - Contract or agreement information"
};

const questionWeights = {
  340: 1.0, 341: 1.0, 335: 1.0, 161: 1.0, 240: 1.0, 241: 1.0, 243: 1.0,
  441: 1.0, 443: 1.0, 315: 1.0, 318: 1.0, 319: 1.0, 317: 1.0, 320: 1.0,
  321: 1.0, 322: 1.0, 323: 1.0, 324: 1.0, 325: 1.0, 326: 1.0, 327: 1.0,
  328: 1.0, 329: 1.0, 330: 1.0, 331: 1.0, 332: 1.0, 333: 1.0, 334: 1.0,
  316: 1.0, 339: 1.0, 170: 1.0, 356: 1.0, 464: 1.0, 342: 1.0, 245: 1.0,
  352: 1.0, 465: 1.0, 444: 1.0, 445: 1.0, 446: 1.0, 447: 1.0, 448: 1.0,
  449: 1.0, 450: 1.0, 451: 1.0, 452: 1.0, 358: 1.0, 314: 1.0, 31401: 1.0,
  31407: 1.0, 31402: 1.0, 31403: 1.0, 31404: 1.0, 31405: 1.0, 31410: 1.0,
  31411: 1.0, 31412: 1.0, 31406: 1.0, 350: 1.0, 236: 1.0, 207: 1.0, 206: 1.0,
  351: 1.0, 379: 1.0, 347: 1.0, 348: 1.0, 380: 1.0, 382: 1.0, 423: 1.0, 349: 1.0
};

let workerData = null;
let payerData = null;

document.getElementById('jsonWorkerInput').addEventListener('change', function (event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      workerData = JSON.parse(e.target.result);
      tryRenderBoth();
    } catch (err) {
      alert("Invalid worker JSON file");
    }
  };
  reader.readAsText(file);
});

document.getElementById('jsonPayerInput').addEventListener('change', function (event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      payerData = JSON.parse(e.target.result);
      tryRenderBoth();
    } catch (err) {
      alert("Invalid payer JSON file");
    }
  };
  reader.readAsText(file);
});

function tryRenderBoth() {
  if (workerData && payerData) {
    const container = document.getElementById('content');
    container.innerHTML = '';
    container.appendChild(renderJSON(workerData, payerData));
    renderProbabilityScore(workerData, payerData);
  }
}

function renderJSON(workerData, payerData) {
  const sectioned = {};
  const hiddenWorkerSections = new Set([
    "payer - section 3 - payee (worker) information"
  ]);

  const hiddenPayerSections = new Set([
    "section 1: general information",
    "worker - section 2a - employee information",
    "worker - section 2b - specified shareholder information",
    "worker - section 3 - payers (clients) information"
  ]);

  function addToSection(ans, isPayer = false) {
    const section = sectionMap[ans.questionId] || "Other";
    if (!sectioned[section]) sectioned[section] = {};
    if (!sectioned[section][ans.questionEn]) {
      sectioned[section][ans.questionEn] = { worker: "", payer: "" };
    }
    const formatted = formatAnswer(ans.answer);
    if (isPayer) {
      sectioned[section][ans.questionEn].payer = formatted;
    } else {
      sectioned[section][ans.questionEn].worker = formatted;
    }
  }

  function formatAnswer(answer) {
    if (Array.isArray(answer)) {
      return answer.map(group =>
        group.map(sub =>
          `${sub.questionEn}: ${sub.answer}`
        ).join("<br>")
      ).join("<hr>");
    }
    return answer || "";
  }

  workerData.forEach(entry => entry.answers.forEach(ans => addToSection(ans, false)));
  payerData.forEach(entry => entry.answers.forEach(ans => addToSection(ans, true)));

  const container = document.createElement('div');

  for (const [section, questions] of Object.entries(sectioned)) {
    const normalizedSection = section.trim().toLowerCase();
    const showWorker = !hiddenWorkerSections.has(normalizedSection);
    const showPayer = !hiddenPayerSections.has(normalizedSection);

    if (!showWorker && !showPayer) continue;

    const table = document.createElement('table');
    let theadHTML = '<thead><tr><th>Question</th>';
    if (showWorker) theadHTML += '<th>Worker</th>';
    if (showPayer) theadHTML += '<th>Payer</th>';
    theadHTML += '</tr></thead>';
    table.innerHTML = theadHTML;

    const tbody = document.createElement('tbody');
    let rowCount = 0;

    for (const [question, { worker, payer }] of Object.entries(questions)) {
      if (!worker && !payer) continue;

      const isMismatch = worker && payer && worker !== payer;

      let rowHTML = `<td>${question}</td>`;
      if (showWorker) {
        rowHTML += `<td style="${isMismatch ? 'background-color: #fff3cd;' : ''}">${worker}</td>`;
      }
      if (showPayer) {
        rowHTML += `<td style="${isMismatch ? 'background-color: #fff3cd;' : ''}">${payer}</td>`;
      }

      const row = document.createElement('tr');
      row.innerHTML = rowHTML;
      tbody.appendChild(row);
      rowCount++;
    }

    if (rowCount > 0) {
      const sectionHeader = document.createElement('h3');
      sectionHeader.textContent = section;
      container.appendChild(sectionHeader);
      table.appendChild(tbody);
      container.appendChild(table);
    }
  }

  return container;
}

function renderProbabilityScore(workerData, payerData) {
  let totalWeight = 0;
  let workerScore = 0;
  let payerScore = 0;

  function scoreAnswer(answer, weight) {
    if (typeof answer === 'string') {
      return answer.trim().toLowerCase() === 'yes' ? weight : 0;
    }
    return 0;
  }

  workerData.forEach(entry => {
    entry.answers.forEach(ans => {
      const weight = questionWeights[ans.questionId] || 1.0;
      totalWeight += weight;
      workerScore += scoreAnswer(ans.answer, weight);
    });
  });

  payerData.forEach(entry => {
    entry.answers.forEach(ans => {
      const weight = questionWeights[ans.questionId] || 1.0;
      payerScore += scoreAnswer(ans.answer, weight);
    });
  });

  const workerPercent = totalWeight ? Math.round((workerScore / totalWeight) * 100) : 0;
  const payerPercent = totalWeight ? Math.round((payerScore / totalWeight) * 100) : 0;

  const probabilityDiv = document.getElementById('probability');
  probabilityDiv.innerHTML = `
    <h3>Confidence level</h3>
    <p><strong>Based on the answers:</strong><br> The percentage is the confidence level <strong>indicator of employment</strong></p>
    ${generateBar("Worker's response", workerPercent)}
    ${generateBar("Payer's response", payerPercent)}
  `;
}

function generateBar(label, percent) {
  let color = "#28a745"; // green
  if (percent < 75) color = "#ffc107"; // yellow
  if (percent < 50) color = "#fd7e14"; // orange
  if (percent < 25) color = "#dc3545"; // red

  return `
    <div style="margin-bottom:1em">
      <label>${label}: ${percent}% (${describeProbability(percent)})</label>
      <div class="probability-bar">
        <div class="probability-fill" style="width: ${percent}%; background-color: ${color};">
          ${percent}%
        </div>
      </div>
    </div>
  `;
}

function describeProbability(percent) {
  if (percent >= 80) return "highly probable";
  if (percent >= 60) return "probable";
  if (percent >= 40) return "neutral";
  if (percent >= 20) return "unlikely";
  return "highly unlikely";
}

 // Optional: WET preFooter
 var defPreFooter = document.getElementById("def-preFooter");
 defPreFooter.outerHTML = wet.builder.preFooter({
   dateModified: "2025-06-02",
   showPostContent: true,
   showFeedback: true,
   showShare: true
 });
</script>
   
  <!-- Probability bar container -->
<div id="probability" style="margin-top: 2em;"></div>
</div></main>

</body>
</html>
