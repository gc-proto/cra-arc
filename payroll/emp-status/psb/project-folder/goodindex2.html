
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Worker vs. payer questionnaire comparison - PSB Determination</title>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="noindex, follow" name="robots"/>


<!-- ✅ Add jQuery first -->
  https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js

<!-- WET Assets -->
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/soyutils.js"></script>
<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/wet-en.js"></script>
<link href="https://test.canada.ca/covid-19-guidance/proto/css/alpha-beta-banner.css" rel="stylesheet"/>
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/m%C3%A9li-m%C3%A9lo/2023-10-mount-revelstoke.min.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" rel="stylesheet">
<link href="https://www.canada.ca/etc/designs/canada/wet-boew/css/theme.min.css" rel="stylesheet"/>


  <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5TBZBZVVK8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5TBZBZVVK8');
    </script>

<!-- Utility framework -->
    <link rel="stylesheet" href="/gcds-utility.min.css" />

    <link rel="stylesheet" href="/styles/prism.css">
    <link rel="stylesheet" href="/styles/style.css">
    <script src="/scripts/code-showcase.js"></script>
    <script src="/scripts/code-copy.js"></script>
    <script src="/scripts/component-preview.js"></script>
    <script src="/scripts/general.js"></script>
    <link rel="icon" type="image/x-icon" sizes="96x96" href="/favicon.ico">

    <!-- GC Design System  Components-->
    <link rel="stylesheet" href="/components/dist/gcds/gcds.css">
    <script type="module" src="/components/dist/gcds/gcds.esm.js"></script>




<!-- Styles -->
<style>
   body {
     font-family: Arial, sans-serif;
     padding: 20px;
   }
   table {
     width: 100%;
     border-collapse: collapse;
     margin-top: 1em;
   }
   th, td {
     border: 1px solid #ccc;
     padding: 8px;
     vertical-align: top;
   }
   th {
     background-color: #f2f2f2;
   }
    pre {
     background: #f4f4f4;
     padding: 10px;
     border-radius: 5px;
   }
   .probability-bar {
     margin-top: 0.2em;
     background: #eee;
     border-radius: 5px;
     height: 30px;
     position: relative;
     width: 100%;
   }
   .probability-fill {
     height: 100%;
     border-radius: 5px;
     text-align: center;
     line-height: 30px;
     color: white;
     font-weight: Bold;
   }

details summary {
  font-weight: bold;
}

details {
  margin-bottom: 1em;
  padding: 0.5em 0.5em;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
}

.td-wrapper {
  position: relative;
  min-height: 3em;
  padding-bottom: 1.5em;
  height: 100%;
}

.score-icon {
  position: absolute;
  bottom: 4px;
  right: 4px;
}
.score-pill {
  display: inline-block;
  padding: 0.3em 0.6em;
  border-radius: 999px;
  margin-right: 0.5em;
  font-size: 0.9em;
  font-weight: bold;
  color: white;
}

.probability-bar {
  display: flex;
  height: 30px;
  border-radius: 999px;
  overflow: hidden;
  margin-bottom: 1em;
}
.probability-bar div {
  height: 100%;
  text-align: center;
  line-height: 30px;
  color: white;
  font-size: 0.8em;
}

@media print {
  body * {
    visibility: hidden;
  }
  #summaryContent, #summaryContent * {
    visibility: visible;
  }
  #summaryContent {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
}
	
</style>
<script type="text/javascript">
   document.write(wet.builder.refTop({}));
</script>
</head>
<body class="experimental" typeof="WebPage" vocab="http://schema.org/">
<div id="def-top"></div>
<main class="container" property="mainContentOfPage" role="main">
<div class="gc-font-2019">
<h1>Worker vs. payer questionnaire comparison<br/>
<small>Questionnaire to determine if the worker's corporation was carrying on a personal services business (PSB)</small>
</h1>

<p class="mrgn-tp-lg">Each PSBCR case is unique and requires a thorough review of the facts to determine if the worker’s corporation was carrying on a personal services business for the period under review. The purpose of this questionnaire is to review the following condition for worker's corporation to have been carrying on a PSB:</p>
   <p class="mrgn-tp-md mrgn-lft-lg">If the corporation did not exist, the worker would <strong>reasonably be considered an employee</strong> of the payer (the corporation’s client) to whom the services were provided.</p>

<h3>Select your case number</h3>

<p>To use this tool, you have to select the case number (and the matching first and last PSB officer name) you want to review.  It will provide you with either the worker (W), the payer (P) or the combined worker and payer (W/P) answers.</p>
<div id="caseSelectorContainer">
  <label for="caseSelector"></label>   <select id="caseSelector"></select>
</div>
<hr>
<div id="summaryContent">

<div id="analysisHeadingContainer" class="row">
  <div class="col-12">
    <div id="analysisHeading"></div>
  <div id="analysisIntro"></div>
  </div>
</div>

	
<div class="row">
<div class="col-md-8">
<div id="content"></div>
</div>
<div class="col-md-4">
<div id="probability"></div>
</div>
</div></div>
<script>
   const sectionMap = {
   
   340: "Section 1 - General information",
    341: "Section 1 - General information",
    335: "Section 1 - General information",
    161: "Section 1 - General information",
   240: "Section 1 - General information",
   241: "Section 1 - General information",
   243: "Section 1 - General information",
   441:  "Section 2 - Business information", 
   443:  "Section 2 - Business information",  
    315: "Section 2 - Business information",
    318: "Section 2 - Business information",
    319: "Section 2 - Business information",
    317: "Section 2 - Business information",
    320: "Section 2 - Business information", 
    321: "Section 2 - Business information",
    322: "Section 2 - Business information",
     323: "Section 2 - Business information",
    324: "Section 2 - Business information",
    325: "Section 2 - Business information",
    326: "Section 2 - Business information", 
    327: "Section 2 - Business information",
    328: "Section 2 - Business information",
    329: "Section 2 - Business information",
    330: "Section 2 - Business information",
    331: "Section 2 - Business information", 
    332: "Section 2 - Business information",
    333: "Section 2 - Business information",
    334: "Section 2 - Business information",
    316: "Section 2 - Business information",
	
   
  339: "Section 2a - Additional business information of the worker",
    170: "Section 2a - Additional business information of the worker",
 356: "Section 2a - Additional business information of the worker",   
  464: "Section 2a - Additional business information of the worker",      
  342: "Section 2a - Additional business information of the worker",     
 245: "Section 2a - Additional business information of the worker",   
 352: "Section 2a - Additional business information of the worker",  
  465: "Section 2a - Additional business information of the worker",     

       444: "Section 3 - Payee (worker) information",      
       445: "Section 3 - Payee (worker) information",   
       446: "Section 3 - Payee (worker) information",   
       447: "Section 3 - Payee (worker) information",   
       448: "Section 3 - Payee (worker) information",   
       449: "Section 3 - Payee (worker) information",   
       450: "Section 3 - Payee (worker) information",   
       451: "Section 3 - Payee (worker) information",   
       452: "Section 3 - Payee (worker) information",   

     314: "Section 3 - Payers (clients) information",   

 350: "Section 4 - Contract or agreement information", 	   
 236: "Section 4 - Contract or agreement information",    
 207: "Section 4 - Contract or agreement information",    
 206: "Section 4 - Contract or agreement information",   
 351: "Section 4 - Contract or agreement information",   
 379: "Section 4 - Contract or agreement information",  
 347: "Section 4 - Contract or agreement information", 
 348: "Section 4 - Contract or agreement information", 
 382: "Section 4 - Contract or agreement information", 
 423: "Section 4 - Contract or agreement information", 
 349: "Section 4 - Contract or agreement information", 
    
189: "Section 5 - Working relationship information",         
389: "Section 5 - Working relationship information",
390: "Section 5 - Working relationship information", 	
391: "Section 5 - Working relationship information",    
    
 192: "Section 5a - Control - Duties (1 of 8)", 
 383: "Section 5a - Control - Duties (1 of 8)",
 424: "Section 5a - Control - Duties (1 of 8)",  	   
 258: "Section 5a - Control - Duties (1 of 8)",  
 257: "Section 5a - Control - Duties (1 of 8)",   
 491: "Section 5a - Control - Duties (1 of 8)", 
 492: "Section 5a - Control - Duties (1 of 8)",  
 479: "Section 5a - Control - Duties (1 of 8)",  	   

     259: "Section 5a - Control - Work schedule (2 of 8)", 
   261: "Section 5a - Control - Work schedule (2 of 8)",   
     262: "Section 5a - Control - Work schedule (2 of 8)",   
      263: "Section 5a - Control - Work schedule (2 of 8)",   
      264: "Section 5a - Control - Work schedule (2 of 8)",   
      265: "Section 5a - Control - Work schedule (2 of 8)",   

     191: "Section 5a - Control - Degree of autonomy (3 of 8)",   
     267: "Section 5a - Control - Degree of autonomy (3 of 8)",   
     268: "Section 5a - Control - Degree of autonomy (3 of 8)",   
     312: "Section 5a - Control - Degree of autonomy (3 of 8)",   
     504: "Section 5a - Control - Degree of autonomy (3 of 8)", 	   
   513: "Section 5a - Control - Degree of autonomy (3 of 8)",   
    494: "Section 5a - Control - Degree of autonomy (3 of 8)",   
    496: "Section 5a - Control - Degree of autonomy (3 of 8)",   
    497: "Section 5a - Control - Degree of autonomy (3 of 8)",   
    499: "Section 5a - Control - Degree of autonomy (3 of 8)",   
    
    297: "Section 5a - Control - Remuneration (4 of 8)",  
    298: "Section 5a - Control - Remuneration (4 of 8)",  
     299: "Section 5a - Control - Remuneration (4 of 8)",  
     271: "Section 5a - Control - Remuneration (4 of 8)",  
     300: "Section 5a - Control - Remuneration (4 of 8)",  
     385: "Section 5a - Control - Remuneration (4 of 8)",  
     301: "Section 5a - Control - Remuneration (4 of 8)",  
    270: "Section 5a - Control - Remuneration (4 of 8)",
     302: "Section 5a - Control - Remuneration (4 of 8)",
    303: "Section 5a - Control - Remuneration (4 of 8)",
    304: "Section 5a - Control - Remuneration (4 of 8)",
    306: "Section 5a - Control - Remuneration (4 of 8)",
    386: "Section 5a - Control - Remuneration (4 of 8)",

  195: "Section 5a - Control - Location of services (5 of 8)", 	   
  466: "Section 5a - Control - Location of services (5 of 8)", 	   
  296: "Section 5a - Control - Location of services (5 of 8)",    
  426: "Section 5a - Control - Location of services (5 of 8)", 	   
  505: "Section 5a - Control - Location of services (5 of 8)", 
  480: "Section 5a - Control - Location of services (5 of 8)", 
	
     274: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 
       275: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 
       428: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 
       276: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 
       388: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 
     429: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 
 506: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 	   
 481: "Section 5a - Control - Right to exercise punitive action and or terminate the relationship (6 of 8)", 	       

      278: "Section 5a - Control - How the work is done (7 of 8)",
	   
          280: "Section 5a - Control - How the work is done (7 of 8)",
         309: "Section 5a - Control - How the work is done (7 of 8)",
          310: "Section 5a - Control - How the work is done (7 of 8)",
      311: "Section 5a - Control - How the work is done (7 of 8)",
    459: "Section 5a - Control - How the work is done (7 of 8)",
  507: "Section 5a - Control - How the work is done (7 of 8)",
   	   484: "Section 5a - Control - How the work is done (7 of 8)",
	    485: "Section 5a - Control - How the work is done (7 of 8)",

      198: "Section 5a - Control - Training (8 of 8)", 
          281: "Section 5a - Control - Training (8 of 8)", 
          282: "Section 5a - Control - Training (8 of 8)", 
          283: "Section 5a - Control - Training (8 of 8)", 

    
 290: "Section 5b - Ownership of tools or equipment", 
 208: "Section 5b - Ownership of tools or equipment", 
 210: "Section 5b - Ownership of tools or equipment",  
 284: "Section 5b - Ownership of tools or equipment",  
 285: "Section 5b - Ownership of tools or equipment", 
 286: "Section 5b - Ownership of tools or equipment",  
482: "Section 5b - Ownership of tools or equipment",  
   471: "Section 5b - Ownership of tools or equipment",  
 473: "Section 5b - Ownership of tools or equipment",  
   474: "Section 5b - Ownership of tools or equipment",  
    475: "Section 5b - Ownership of tools or equipment",  
    476: "Section 5b - Ownership of tools or equipment",  
    477: "Section 5b - Ownership of tools or equipment",  
	

     430: "Section 5c - Financial information",  
     211: "Section 5c - Financial information",  
     214: "Section 5c - Financial information",  
     216: "Section 5c - Financial information",  
     218: "Section 5c - Financial information",  
      219: "Section 5c - Financial information",  
     233: "Section 5c - Financial information",  
    234: "Section 5c - Financial information",  
	    490: "Section 5c - Financial information", 	   
	    495: "Section 5c - Financial information", 
	    500: "Section 5c - Financial information", 
	    478: "Section 5c - Financial information", 
	    486: "Section 5c - Financial information", 
	    487: "Section 5c - Financial information", 
   
   431: "Section 5a - Carrying out the work",   
   397: "Section 5a - Carrying out the work", 
   468: "Section 5a - Carrying out the work", 	   
     398: "Section 5a - Carrying out the work", 
     433: "Section 5a - Carrying out the work", 
     399: "Section 5a - Carrying out the work", 
     432: "Section 5a - Carrying out the work", 
     393: "Section 5a - Carrying out the work", 
     394: "Section 5a - Carrying out the work", 
 508: "Section 5a - Carrying out the work", 	   
	   510: "Section 5a - Carrying out the work", 
	     511: "Section 5a - Carrying out the work", 
     

     400: "Section 5b - Remuneration",   
    402: "Section 5b - Remuneration", 
    403: "Section 5b - Remuneration", 
      404: "Section 5b - Remuneration", 
      435: "Section 5b - Remuneration", 
      405: "Section 5b - Remuneration", 
      406: "Section 5b - Remuneration", 
      407: "Section 5b - Remuneration", 
      408: "Section 5b - Remuneration", 
      410: "Section 5b - Remuneration", 
      436: "Section 5b - Remuneration", 
      411: "Section 5b - Remuneration", 

     
     412: "Section 5c - Relationship of subordination", 
     413: "Section 5c - Relationship of subordination",  
    414: "Section 5c - Relationship of subordination",  
    415: "Section 5c - Relationship of subordination",  
    416: "Section 5c - Relationship of subordination",  
 532: "Section 5c - Relationship of subordination",  	   
    417: "Section 5c - Relationship of subordination", 
 533: "Section 5c - Relationship of subordination",  
 534: "Section 5c - Relationship of subordination",  	   
    418: "Section 5c - Relationship of subordination",  
    419: "Section 5c - Relationship of subordination",  
    420: "Section 5c - Relationship of subordination",  
    421: "Section 5c - Relationship of subordination",  
   422: "Section 5c - Relationship of subordination",  
   438: "Section 5c - Relationship of subordination",  
   439: "Section 5c - Relationship of subordination",   
   460: "Section 5c - Relationship of subordination",  
   509: "Section 5c - Relationship of subordination",  
	   512: "Section 5c - Relationship of subordination",  
	   493: "Section 5c - Relationship of subordination",  
	   517: "Section 5c - Relationship of subordination",  
	   514: "Section 5c - Relationship of subordination",  
	   515: "Section 5c - Relationship of subordination",  
	   516: "Section 5c - Relationship of subordination",  
	   527: "Section 5c - Relationship of subordination",  
	   528: "Section 5c - Relationship of subordination",  
	   529: "Section 5c - Relationship of subordination",  
	   520: "Section 5c - Relationship of subordination",  
	   521: "Section 5c - Relationship of subordination",  
	   522: "Section 5c - Relationship of subordination",  
	   523: "Section 5c - Relationship of subordination",  
	   524: "Section 5c - Relationship of subordination",  
	    526: "Section 5c - Relationship of subordination", 
	    518: "Section 5c - Relationship of subordination", 
	    519: "Section 5c - Relationship of subordination", 
	    525: "Section 5c - Relationship of subordination", 
	    530: "Section 5c - Relationship of subordination", 
	   531: "Section 5c - Relationship of subordination", 

 360: "Section 6 - Certification", 
 363: "Section 6 - Certification", 
  376: "Section 6 - Certification", 
     364: "Section 6 - Certification", 
     366: "Section 6 - Certification", 
     373: "Section 6 - Certification", 
    375: "Section 6 - Certification", 
 362: "Section 6 - Certification" 

   // Add more mappings as needed
 };



const excludedSections = new Set([
  "section 1 - general information",
  "section 2 - business information",	
  "section 2a - additional business information of the worker",
  "section 3 - payee (worker) information",
  "section 3 - payers (clients) information",
  "section 4 - contract or agreement information",	
 "section 5 - working relationship information", 	
  "section 6 - certification"
]);

const sectionQuestionExclusions = {

// trying to remove this as it is not working
};
	
let workerData = null;
let payerData = null;


function handleSmartJsonUpload(file) {
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const jsonData = JSON.parse(e.target.result);
     
	workerCases = new Map();
	payerCases = new Map();


      jsonData.forEach(entry => {
        const q441 = entry.answers.find(a => a.questionId === 441);
        const caseAns = entry.answers.find(a => a.questionId === 341);
        const caseNumber = caseAns && caseAns.answer ? caseAns.answer.trim() : "Unknown";

        if (q441 && q441.answer.includes("Worker whose corporation")) {
          workerCases.set(caseNumber, entry);
        } else if (q441 && q441.answer.includes("Payer who made payments")) {
          payerCases.set(caseNumber, entry);
        }
      });

      const workerKeys = [...workerCases.keys()];
      const payerKeys = [...payerCases.keys()];
      const allKeys = [...new Set([...workerKeys, ...payerKeys])];


if (workerKeys.length > 0 || payerKeys.length > 0) {
  handleCaseSelection(workerCases, payerCases);
} else {
  alert("Could not determine if the file is for a worker or payer.");
}


    } catch (err) {
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
}



function tryRenderBoth() {
  if (!workerData && !payerData) return;

  const workerCases = workerData ? extractCaseNumbers(workerData) : new Map();
  const payerCases = payerData ? extractCaseNumbers(payerData) : new Map();

  handleCaseSelection(workerCases, payerCases);
}

function extractCaseNumbers(data) {
  const cases = new Map(); // Map of caseNumber -> entry
  data.forEach(entry => {
    const caseAns = entry.answers.find(a => a.questionId === 341);
    if (caseAns && caseAns.answer) {
      cases.set(caseAns.answer.trim(), entry);
    }
  });
  return cases;
}

function updateCaseSelector(caseNumbers) {
  console.log("Updating dropdown with cases:", caseNumbers);
  const dropdown = document.getElementById("caseSelector");
  dropdown.innerHTML = "";

  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "Make your selection...";
  defaultOption.disabled = true;
  defaultOption.selected = true;
  dropdown.appendChild(defaultOption);

  caseNumbers.forEach(cn => {
    const option = document.createElement("option");
    option.value = cn;

    let label = cn;
    const hasWorker = workerCases.has(cn);
    const hasPayer = payerCases.has(cn);

    if (hasWorker && hasPayer) label += " (W/P)";
    else if (hasWorker) label += " (W)";
    else if (hasPayer) label += " (P)";

    const entry = workerCases.get(cn) || payerCases.get(cn);
    const nameAnswer = entry?.answers.find(a => a.questionId === 241);
    const idAnswer = entry?.answers.find(a => a.questionId === 243);
    const name = nameAnswer ? nameAnswer.answer : "";
    const id = idAnswer ? idAnswer.answer : "";

    if (name || id) {
      label += ` - ${[id, name].filter(Boolean).join(" ")}`;
    }

    option.textContent = label;
    dropdown.appendChild(option);
  });

  document.getElementById("caseSelectorContainer").style.setProperty("display", "block", "important");

  // Select and trigger change only if one case
  if (caseNumbers.length === 1) {
    dropdown.selectedIndex = 1;
    dropdown.dispatchEvent(new Event("change"));
  }
}

function handleCaseSelection(workerCases, payerCases) {
  const workerKeys = [...workerCases.keys()];
  const payerKeys = [...payerCases.keys()];
  const allKeys = [...new Set([...workerKeys, ...payerKeys])];
  const matching = workerKeys.filter(k => payerCases.has(k));

  const dropdown = document.getElementById("caseSelector");

  // ✅ Set the event handler BEFORE any selection logic
  dropdown.onchange = () => {
    if (dropdown.value) {
      renderSelectedCase(workerCases, payerCases, dropdown.value);
      
    }
  };

  // ✅ Multiple matching cases
 if (allKeys.length > 1) {
  updateCaseSelector(allKeys);
}


  // ✅ Exactly one matching case
  else if (matching.length === 1) {
    document.getElementById("caseSelectorContainer").style.display = "none";
    renderSelectedCase(workerCases, payerCases, matching[0]);
  }

  // ✅ Only one case total (worker or payer)
  else if (allKeys.length === 1) {
    console.log("Only one case found, showing dropdown.");
    updateCaseSelector(allKeys);

    setTimeout(() => {
      const dropdown = document.getElementById("caseSelector");
      if (!dropdown) {
        console.error("Dropdown not found!");
        return;
      }

      console.log("Dropdown options:", [...dropdown.options].map(opt => opt.textContent));
      dropdown.value = allKeys[0]; // Select by value
      dropdown.dispatchEvent(new Event("change"));
    }, 50);
  }

  // ✅ Multiple cases but no match — show all
  else if (allKeys.length > 1) {
    updateCaseSelector(allKeys);
  }
}


function renderSelectedCase(workerCases, payerCases, caseNumber) {
  const container = document.getElementById("content");
  container.innerHTML = "";

  const workerEntry = workerCases.get(caseNumber);
  const payerEntry = payerCases.get(caseNumber);

  if (workerEntry && payerEntry) {
    container.appendChild(renderJSON([workerEntry], [payerEntry]));
    renderProbabilityScore([workerEntry], [payerEntry]);
  } else if (workerEntry) {
    container.appendChild(renderJSON([workerEntry], []));
    renderProbabilityScore([workerEntry], []);
  } else if (payerEntry) {
    container.appendChild(renderJSON([], [payerEntry]));
    renderProbabilityScore([], [payerEntry]);
  }
}

	
function renderJSON(workerData, payerData) {
  const showWorker = workerData.length > 0;
  const showPayer = payerData.length > 0;

   const sectioned = {};

   function addToSection(ans, isPayer = false) {
    const section = sectionMap[ans.questionId] || "Other";
    if (!sectioned[section]) sectioned[section] = {};
    if (!sectioned[section][ans.questionEn]) {
      sectioned[section][ans.questionEn] = {
        worker: "", payer: "", rawWorker: "", rawPayer: ""
      };
    }
    const formatted = formatAnswer(ans.answer);
    
const raw = typeof ans.answer === 'string' ? normalizeAnswer(ans.answer) : JSON.stringify(ans.answer);
  
    if (isPayer) {
      sectioned[section][ans.questionEn].payer = formatted;
      sectioned[section][ans.questionEn].rawPayer = raw;
    } else {
      sectioned[section][ans.questionEn].worker = formatted;
      sectioned[section][ans.questionEn].rawWorker = raw;
    }
  }

function formatAnswer(answer) {
  if (Array.isArray(answer)) {
    return answer.map((group, index) => {
      const table = document.createElement("table");
      table.innerHTML = `<thead><tr><th colspan="2">User entry #${index + 1}</th></tr><tr><th>Question</th><th>Answer</th></tr></thead>`;
      const tbody = document.createElement("tbody");

      group.forEach(sub => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${sub.questionEn}</td><td>${sub.answer}</td>`;
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      return table.outerHTML;
    }).join("<br><br>");
  }

  return answer || "";
}

	 const skipMismatchHighlighting = [
  "Section 1 - General information",
  "Section 2 - Business information",
  "Section 2a - Additional business information of the worker",
  "Section 3 - Payee (worker) information",
  "Section 3 - Payers (clients) information",
  "Section 6 - Certification"
      
];

 

  workerData.forEach(entry => entry.answers.forEach(ans => addToSection(ans, false)));
  payerData.forEach(entry => entry.answers.forEach(ans => addToSection(ans, true)));
  const container = document.createElement('div');

for (const [section, questions] of Object.entries(sectioned)) {
  const table = document.createElement('table');

let showWorker = workerData.length > 0;
let showPayer = payerData.length > 0;

// Special rules for column visibility
if (section === "Section 1 - General information" && showWorker && showPayer) {
  showPayer = false;
}
if (section === "Section 2a - Additional business information of the worker" && showWorker && showPayer) {
  showPayer = false;
}
if (section === "Section 3 - Payers (clients) information" && showWorker && showPayer) {
  showPayer = false;
}
if (section === "Section 3 - Payee (worker) information" && showWorker && showPayer) {
  showWorker = false;
}


   if (!showWorker && !showPayer) continue;

let theadHTML = '<thead><tr><th>Question</th>';
if (showWorker) {
 const label = (section === "Section 1 - General information" && workerData.length > 0 && payerData.length > 0) ? "Answer" : "Worker";

  theadHTML += `<th>${label}</th>`;
}
if (showPayer) theadHTML += '<th>Payer</th>';
theadHTML += '</tr></thead>';


	
  table.innerHTML = theadHTML;

  const tbody = document.createElement('tbody');
  let rowCount = 0;

  for (const [question, data] of Object.entries(questions)) {
    const { worker, payer, rawWorker, rawPayer } = data;
    if (!worker && !payer) continue;

    const isMismatch = !skipMismatchHighlighting.includes(section) &&
      rawWorker && rawPayer && rawWorker !== rawPayer;

const isExcluded = excludedSections.has(normalize(section));

	  
    const row = document.createElement('tr');
    let rowHTML = `<td>${question}</td>`;
  if (showWorker) {
const workerIcon = isExcluded ? '' : getScoreIcon(
  Object.keys(sectionMap).find(id =>
    sectionMap[id] === section &&
    workerData.some(d => d.answers.some(a => a.questionEn === question && a.questionId == id))
  ),
  data.rawWorker
);
rowHTML += `<td style="${isMismatch ? 'background-color: #fff3cd;' : ''}; position: relative;">
<div class="td-wrapper">
  <div style="margin-bottom: 1.5em;">${worker}</div>
  ${workerIcon}
</div>
</td>`;

}

if (showPayer) {
  const payerIcon = isExcluded ? '' : getScoreIcon(
  Object.keys(sectionMap).find(id =>
    sectionMap[id] === section &&
    payerData.some(d => d.answers.some(a => a.questionEn === question && a.questionId == id))
  ),
  data.rawPayer
);

rowHTML += `<td style="${isMismatch ? 'background-color: #fff3cd;' : ''}; position: relative;">
 <div class="td-wrapper">
  <div style="margin-bottom: 1.5em;">${payer}</div>
  ${payerIcon}
</div>
</td>`;


}

    row.innerHTML = rowHTML;
    tbody.appendChild(row);
    rowCount++;
  }

  if (rowCount > 0) {
    const shouldCollapse = [
      "Section 2 - Business information",
      "Section 2a - Additional business information of the worker",
      "Section 3 - Payee (worker) information",
      "Section 3 - Payers (clients) information",
      "Section 6 - Certification"
    ].includes(section);

    if (shouldCollapse) {
   const details = document.createElement('details');
// details.setAttribute('open', ''); // Collapse by default
   const summary = document.createElement('summary');
      summary.textContent = section;
      details.appendChild(summary);
      table.appendChild(tbody);
      details.appendChild(table);
      container.appendChild(details);
    } else {
      const sectionHeader = document.createElement('h3');
      sectionHeader.textContent = section;
      container.appendChild(sectionHeader);
      table.appendChild(tbody);
      container.appendChild(table);
    }
  }
}

  return container;
}

function normalize(section) {
  return (section || "")
   .trim()
.toLowerCase()
.replace(/[’‘]/g, "'")
.replace(/[\u2013\u2014\u2012\u2010]/g, '-')
.replace(/\s+/g, ' ')
.replace(/[^a-z0-9\s'/-]/g, ''); // strip unexpected punctuation
}

</script>
<!-- Probability bar container -->
<div id="probability" style="margin-top: 2em;"></div>
<!-- WET PreFooter -->
</div></main>


<script>

function normalizeAnswer(answer) {
return String(answer || "")
.trim()
.toLowerCase()
.replace(/[’‘]/g, "'")
.replace(/[\u2013\u2014\u2012\u2010]/g, '-')
.replace(/\s+/g, ' ')
.replace(/[^a-z0-9\s'/-]/g, ''); // strip unexpected punctuation
}


const customScoringRules = {
   
  207: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
	  case "yes - you must send a copy of the contract or agreement with this questionnaire": return -2;  // 
      case "no": return -2;  // 	Information to help with the contract review     
  
    }
  },

  206: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return -2; // Information to help with the contract review 
      case "no": return -2; // Information to help with the contract review 
    }
  },


  347: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
   case "yes": return -2; // Information to help with the contract review 
      case "no": return -2; // Information to help with the contract review 
    }
  },
	
  348: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
    case "yes": return -2; // Information to help with the contract review 
      case "no": return -2; // Information to help with the contract review 
    }
  },

	 382: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
      case "worker": return -1; // Indicator of contract for services
     case "payer and worker": return 0;  // Neutral    
    }
  },


  349: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
    case "yes": return -2; // Information to help with the contract review 
      case "no": return -2; // Information to help with the contract review 	    
    }
  },
	
    351: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "employer-employee": return 1; // Indicator of contract of service
      case "self-employed worker": return -1; // Indicator of contract for services	    
    }
  },
   

   
	
  192: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
    }
  },
    383: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "payer": return 1; // Indicator of contract of service
     case "worker": return -1; // Indicator of contract for services
     case "payer and worker": return -2; //   
    }
  },
    258: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    }
  },
    257: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    }
  },

  492: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    }
  },

  479: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
    case "worker's corporation": return -1; // Indicator of contract for services
    }
  },	
	
	259: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    }
  },
  261: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
      case "does not apply": return 0; // Neutral	    
    
    }
  },
262: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
     
    }
  },
  263: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
      
    }
  },
  264: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
   
    }
  },
  265: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
  
    }
  },
  191: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
    
    }
  },
 267: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
    
    }
  },

 268: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
    
    }
  },

 513: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	case "no": return -1; // Indicator of contract for services
    
    }
  },

 494: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
      
    }
  },

 496: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
    
    }
  },
 497: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
     
    }
  },
	
 499: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
      
    }
  },
	
	
   297: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
     
    }
  },
  
   298: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
    
    }
  },
  
   299: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes - t4 slip": return 1; // Indicator of contract of service
      case "no - t4a slip": return -1; // Indicator of contract for services
      case "no - t5018 slip": return -1; // Indicator of contract for services	
      case "no - t4-nr slip": return -1; // Indicator of contract for services
      case "no - no slip issued": return -1; // Indicator of contract for services    
  
    }
  },
   271: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
     
    }
  },
 300: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "hourly/monthly": return 1; // Indicator of contract of service
      case "percentage of job completion/piecework": return -2; // 	Information to help with the contract review 
	  case "other": return -1; // Indicator of contract for services	  	    
   
    }
  },
   301: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	    case "no": return -1; // Indicator of contract for services
      
    }
  },
   270: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
   302: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
   303: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
   304: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
     
    }
  },
   306: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "filing a timesheet": return 1; // Indicator of contract of service
	case "sending an invoice": return -1; // Indicator of contract for services
	  case "other": return -2; // 	 Information to help with the contract review 	    
      
    }
  },

 195: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "payer's location": return 1; // Indicator of contract of service
     case "worker's location": return -1; // Indicator of contract for services	
     case "mobile locations": return -2; //  Information to help with the contract review
     case "client's location": return -2; //  Information to help with the contract review
    case "other options for transportation workers": return -2; // Information to help with the contract review 
    }
  },

 466: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "home terminal or dispatch center": return -2; // Information to help with the contract review
     case "on the road/in transit": return -2; // Information to help with the contract review
     case "delivery or pickup locations": return -2; // Information to help with the contract review
     case "specific route or corridor": return -2; // 	Information to help with the contract review 
     case "client facility or yard": return -2; //  Information to help with the contract review
     case "remote or temporary worksite": return -2; //  Information to help with the contract review
     case "rail yard, port, or airport": return -2; // 	Information to help with the contract review 
     case "other": return -2; // Information to help with the contract review		    
        }
  },

//Who determined where the worker performed the services under the contract?
   296: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
       case "payer": return 1; // Indicator of contract of service
     case "worker": return -1; // Indicator of contract for services
   case "payer and worker": return -2; // 	  Information to help with the contract review   
    }
  },

//Who decided where the truck used by the worker (truck driver) would be parked? 
480: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
     case "worker": return -1; // Indicator of contract for services
    case "payer and worker": return -2; // Information to help with the contract review 	
    case "does not apply": return -2; // Information to help with the contract review 		    
    }
  },
	
  274: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    }
  },
  275: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes - with or without cause": return -2; // Information to help with the contract review 
     case "no":  return -2; // Information to help with the contract review 
     case "yes - with cause":  return -2; // Information to help with the contract review 	 
    }
  },
  428: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
         }
  },
	
  276: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    
    }
  },
	
  429: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
    }
  },
	
  481: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "no": return 1; // Indicator of contract of service
    case "yes": return -1; // Indicator of contract for services
   
    }
  },	
  
  	
  280: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
     case "no": return -1; // Indicator of contract for services
        }
  },

 278: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
        case "yes": return 1; // Indicator of contract of service
        case "no": return -1; // Indicator of contract for services
	 case "not applicable - schedule is regular": return -2; // Information to help with the contract review 	     	  		     
    }
  },
  
  309: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
    }
  },

 
  459: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
   
    }
  },


  484: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return -1; // Indicator of contract for services
    case "no": return 1; // Indicator of contract of service
     
    }
  },

 485: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review 	
      case "does not apply": return 0; // Neutral			    
    
    }
  },	
	
  198: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
    
    }
  },
  281: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
 
    }
  },
  282: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
  case "no": return -1; // Indicator of contract for services
  
    }
  },
  283: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
  case "does not apply": return 0; // Neutral		    
    
    }
  },

	
  290: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
    case "no": return -1; // Indicator of contract for services
    }
  },
  208: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
     case "worker": return -1; // Indicator of contract for services
     case "payer and worker": return -2; // 	Information to help with the contract review     
     
    }
  },
	
  284: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
     case "no": return -1; // Indicator of contract for services
     case "does not apply": return 0;  // Neutral	    
     }
  },
  285: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
	 case "does not apply": return 0;  // Neutral		    
    }
  },
  286: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review 	
	 case "does not apply": return 0;  // Neutral		    
      }
  },

  471: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "owned by the worker": return -2; // Information to help with the contract review 
     case "owned by the corporation of the worker": return -2; // Information to help with the contract review 
     case "owned by the payer": return -2; // Information to help with the contract review 
     case "leased by the worker": return -2; // Information to help with the contract review 
     case "leased by the corporation of the worker": return -2; // Information to help with the contract review 
     case "leased by the payer": return -2; // Information to help with the contract review 
      case "don't know": return -2; // Information to help with the contract review 
     
    }
  },

 473: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // 		    
     
    }
  },	

 474: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Neutral	
  case "don't know": return 1; // Indicator of contract of service		    
      
    }
  },

 475: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review 	
	  case "don't know": return 1; // Indicator of contract of service	    
     
    }
  },

  476: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
    
    }
  },	

 477: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review 		    
     
    }
  },	
	
  430: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
   
    }
  },
  
  211: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
      case "no": return -1; // Indicator of contract for services
    
    }
  },
  214: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
     case "no": return -1; // Indicator of contract for services

    }
  },
  216: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	case "no": return -1; // Indicator of contract for services
     
    }
  },

  219: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	 case "no": return -1; // Indicator of contract for services
     
    }
  },
  233: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	case "no": return -1; // Indicator of contract for services
     
    }
  },
	
  495: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	case "no": return -1; // Indicator of contract for services
    
    }
  },

//Who was responsible for paying for the insurance?	
   478: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
      case "worker": return -1; // Indicator of contract for services
      case "worker's corporation": return -1; // Indicator of contract for services	
      case "payer and worker": return -2; // 	Information to help with the contract review 	    
     case "don't know": return -2; // 	Information to help with the contract review 	    
    }
  },

 486: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	    case "worker": return -1; // Indicator of contract for services
	  case "payer and worker": return -2; // Information to help with the contract review 
	  case "don't know":  return -2; // Information to help with the contract review 		    
      
    }
  },	

 487: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	    case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review 
	  case "don't know":  return -2; // 	Information to help with the contract review 
    }
  },	
    431: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -2;  // Information to help with the contract review 
     
    }
  },
 397: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "payer's location": return 1; // Indicator of contract of service
     case "worker's location": return -1; // Indicator of contract for services	
     case "mobile locations": return -2; //  Information to help with the contract review
     case "client's location": return -2; //  Information to help with the contract review
    case "other options for transportation workers": return -2; // Information to help with the contract review 
    }
  },

 468: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "home terminal or dispatch center": return -2; // Information to help with the contract review
     case "on the road/in transit": return -2; // Information to help with the contract review
     case "delivery or pickup locations": return -2; // Information to help with the contract review
     case "specific route or corridor": return -2; // 	Information to help with the contract review 
     case "client facility or yard": return -2; //  Information to help with the contract review
     case "remote or temporary worksite": return -2; //  Information to help with the contract review
     case "rail yard, port, or airport": return -2; // 	Information to help with the contract review 
     case "other": return -2; // Information to help with the contract review		    
        }
  },

  398: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review		    
     
    }
  },
  399: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	    case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review	
      
    }
  },
  393: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  394: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },

  510: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	    case "worker's corporation": return -1; // Indicator of contract for services

    }
  },
	
  511: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	    case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review	
	case "does not apply": return 0; // Neutral		    
     
    }
  },
	
  400: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
     case "no": return -1; // Indicator of contract for services
  
    }
  },
  402: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  403: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
     case "yes - t4 and rl-1 slips": return 1; // Indicator of contract of service
      case "no - t4a slip": return -1; // Indicator of contract for services
      case "no - t5018 slip": return -1; // Indicator of contract for services	
      case "no - t4-nr slip": return -1; // Indicator of contract for services
      case "no - no slip issued": return -1; // Indicator of contract for services    
    }
  },

  404: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
       case "hourly/monthly": return 1; // Indicator of contract of service
      case "percentage of job completion/piecework": return -2; // Information to help with the contract review
      case "other": return -2; // Information to help with the contract review	    
    
    }
  },
  405: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    
    }
  },
  406: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  407: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  408: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
       
    }
  },
  410: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "filing a timesheet": return 1; // Indicator of contract of service
	   case "sending an invoice": return -1; // Indicator of contract for services
	case "other": return -2; // Information to help with the contract review	    
     
    }
  },
  411: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
     
    }
  },



  412: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  413: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
     
    }
  },
  414: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  415: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  416: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    
    }
  },
	
  532: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    
    }
  },
	
  417: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  533: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    
    }
  },
  534: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
		    case "does not apply": return 0;  // Neutral	    
     
    }
  },
	
  418: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
      
    }
  },
  419: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
     
    }
  },
  420: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
    
    }
  },
  421: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
     
    }
  },
  422: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes - with or without cause": return -2; //	Information to help with the contract review
     case "no": return -2; // 	Information to help with the contract review
     case "yes - with cause": return -2; // Information to help with the contract review	 
    
    }
  },
   438: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
		    case "no": return -1; // Indicator of contract for services
     
    }
  },
  439: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
      
    }
  },

 512: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
     
    }
  },
 493: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return -1; // Indicator of contract for services
	  case "no": return 1; // Indicator of contract of service
      
    }
  },
 517: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return -1; // Indicator of contract for services
	  case "no": return 1; // Indicator of contract of service
      
    }
  },
 514: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
     
    }
  },
 515: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
       
    }
  },
 516: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
      
    }
  },

//Who decided where the truck used by the worker (truck driver) would be parked?
  527: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review		
	 case "does not apply": return -2; // Information to help with the contract review			    
     
    }
  },
 528: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return -1; // Indicator of contract for services
	  case "no": return 1; // Indicator of contract of service
    
    }
  },	
 529: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return -1; // Indicator of contract for services
	  case "no": return 1; // Indicator of contract of service
    
    }
  },

   520: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "owned by the worker": return -2; // Information to help with the contract review  
     case "owned by the corporation of the worker": return -2; //   Information to help with the contract review
     case "owned by the payer": return -2; //   Information to help with the contract review
     case "leased by the worker": return -2; //   Information to help with the contract review
     case "leased by the corporation of the worker": return -2; //  Information to help with the contract review 
     case "leased by the payer": return -2; //  Information to help with the contract review 
      case "don't know": return -2; // Information to help with the contract review        
    }
  },

  521: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review    
      
    }
  },	
  522: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review	
	 case "don't know": return -2; // 	Information to help with the contract review	    
     
    }
  },	
  523: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review	
	 case "don't know": return -2; // Information to help with the contract review
    }
  },
 524: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
    
    }
  },
  526: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; //    Information to help with the contract review 
     
    }
  },	
 518: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "yes": return 1; // Indicator of contract of service
	  case "no": return -1; // Indicator of contract for services
      
    }
  },
  525: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
  case "worker's corporation": return -1; // Indicator of contract for services		    
	 case "payer and worker": return -2; // 	Information to help with the contract review	
	case "don't know": return -2; // 	Information to help with the contract review
    }
  },	
  530: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	  case "payer and worker": return -2; // Information to help with the contract review		
	case "don't know": return -2; // Information to help with the contract review	
    }
  },	
  531: answer => {
     const normalized = normalizeAnswer(answer);   switch (normalized) {
      case "payer": return 1; // Indicator of contract of service
	  case "worker": return -1; // Indicator of contract for services
	 case "payer and worker": return -2; // Information to help with the contract review		
	case "don't know": return -2; // 	Information to help with the contract review  	    
     
    }
  },	

};


function scoreAnswer(answer, questionId) {
  const rule = customScoringRules[questionId];
  if (rule) return rule(answer);
  return -2; // Default to information documents if no rule found
}

function getScoreIcon(questionId, answer) {
  const score = scoreAnswer(answer, questionId);
  let icon = '';
  let color = '';
  let title = '';

  if (score === 1) {
    icon = 'fas fa-users';
    color = 'green';
    title = 'Contract of service (employment)';
  } else if (score === -1) {
    icon = 'fas fa-user-tie';
    color = '#004085';
    title = 'Contract for services (self-employed worker)';
  } else if (score === 0) {
    icon = 'fas fa-not-equal';
    color = 'grey';
    title = 'Neutral';
  }
 else if (score === -2) {
    icon = 'fas fa-book';
    color = '#a2bffe';
    title = 'Information to help with the contract review';
  }	

  if (icon) {
    return `
      <div class="score-icon">
        <i class="fas ${icon}" style="color: ${color};" title="${title}"></i>
      </div>`;
  }

  return '';
}
	
	
</script>

<script>
function normalize(section) {
return (section || "").trim().toLowerCase();
}
	
function calculateSectionScores(data) {
  const totalsScores = {}, cosScores = {}, cfsScores = {}, neutralsScores = {}, infoScores = {}; 

  data.forEach(entry => {
    entry.answers.forEach(ans => {
      const section = sectionMap[ans.questionId] || "Other";
      const normalizedSection = normalize(section);
      const exclusions = sectionQuestionExclusions[section] || [];

      if (!excludedSections.has(normalizedSection)) {
        if (!totalsScores[section]) {
          totalsScores[section] = 0;
 	  cosScores[section] = 0;
          cfsScores[section] = 0;
 	  neutralsScores[section] = 0;
          infoScores[section] = 0;	
        }

        if (ans.answer && ans.answer !== "") {
          totalsScores[section]++;
          if (!exclusions.includes(ans.questionId)) {
            const score = scoreAnswer(ans.answer, ans.questionId);
	  console.log("QID:", ans.questionId, "Answer:", ans.answer, "Score:", score, "Section:", section);

            if (score === 1) cosScores[section]++;
            else if (score === -1) cfsScores[section]++;
	    else if (score === 0) neutralsScores[section]++;
	    else if (score === -2) infoScores[section]++;	  
	  }
        }
      }
    });
  });

  return {totalsScores, cosScores, cfsScores, neutralsScores, infoScores};
}

function getIndicatorIcon(score) {
  if (score === 1) {
    return `<i class="fas fa-users" style="color: green;" title="Contract of service"></i>`;
  } 
   else if (score === -1) {
    return `<i class="fas fa-user-tie" style="color: #004085;" title="Contract for services"></i>`;
 }	  
  else if (score === 0) {
    return `<i class="fas fa-not-equal" style="color: grey;" title="Neutral"></i>`;	  
  } 
  else if (score === -2) {
    return `<i class="fas fa-book" style="color: #a2bffe;" title="Information to help with the contract review"></i>`;
  }
}

function generateDistributionBar(cos, cfs, neutral, info, total) {
  const cosPercent = total ? (cos / total * 100).toFixed(1) : 0;
  const cfsPercent = total ? (cfs / total * 100).toFixed(1) : 0;
  const neutralPercent = total ? (neutral / total * 100).toFixed(1) : 0;
  const infoPercent = total ? (info / total * 100).toFixed(1) : 0;	

  return `
    <div class="probability-bar">
      <div style="width:${cosPercent}%; background: green;">${cos > 0 ? cosPercent + "%" : ""}</div>
      <div style="width:${cfsPercent}%; background: #004085;">${cfs > 0 ? cfsPercent + "%" : ""}</div>
      <div style="width:${neutralPercent}%; background: gray;">${neutral > 0 ? neutralPercent + "%" : ""}</div>
       <div style="width:${infoPercent}%; background: #a2bffe;">${info > 0 ? infoPercent + "%" : ""}</div>
    </div>
  `;
}	
	


function renderProbabilityScore(workerData, payerData) {
  const probabilityDiv = document.getElementById('probability');

  // Inject heading into full-width container above the row
const headingContainer = document.getElementById('analysisHeading');
if (headingContainer) {
  headingContainer.innerHTML = ''; // Clear previous content

  // Create and insert the <h2> heading
  let headingText = '';
  if (workerData.length > 0 && payerData.length > 0) {
    headingText = "Worker's and payer's answers – Begin your full analysis using each factor";
  } else if (workerData.length > 0) {
    headingText = "Worker's answers – Begin your analysis using each factor";
  } else if (payerData.length > 0) {
    headingText = "Payer's answers – Begin your analysis using each factor";
  }

  if (headingText) {
    const heading = document.createElement('h2');
    heading.textContent = headingText;
    heading.classList.add('mt-4', 'mb-3');
    headingContainer.appendChild(heading);
  }

  // Remove any previous introDetails if it exists
  const existingDetails = document.getElementById('introDetails');
  if (existingDetails) existingDetails.remove();

  // Create <details> container
  const details = document.createElement('details');
  details.id = 'introDetails';
  details.open = true;

  // Create <summary>
  const summary = document.createElement('summary');
  summary.innerHTML = '<strong>About this summary</strong>';
  details.appendChild(summary);

  // Create content container
  const introContainer = document.createElement('div');
  introContainer.id = 'analysisIntro';
  introContainer.innerHTML = `
    <p>The questionnaire uses the following icons to categorize the answers received:</p>
    <ul class="list-unstyled">
      <li class="mrgn-lft-lg"><i class="fas fa-users" style="color: green;" title="Contract of service"></i> Contract of service (employment)</li>
      <li class="mrgn-lft-lg"><i class="fas fa-user-tie" style="color: #004085;" title="Contract for services"></i> Contract for services (self-employed worker)</li>
      <li class="mrgn-lft-lg"><i class="fas fa-not-equal" style="color: grey;" title="Neutral"></i> Neutral</li>
      <li class="mrgn-lft-lg"><i class="fas fa-book" style="color: #a2bffe;" title="Information to help with the contract review"></i> Information to help with the contract review</li>
    </ul>
    <p class="mrgn-tp-md">These categorizations are <strong>generally</strong> accurate for the indicators reviewed. However, depending on the facts of this review, these icons may not always apply. To make a final decision, you need to review <strong>all</strong> indicators together, along with the documents sent by both the payer and the worker.</p>
  `;

  // Add mismatch note if both sets of answers are present
  if (workerData.length > 0 && payerData.length > 0) {
    const mismatchNote = document.createElement('p');
    mismatchNote.classList.add('mrgn-tp-md');
    mismatchNote.innerHTML = `To help you quickly spot mismatches between the 2 answers, if the worker and payer answers are different, the cells will be highlighted in <span style="background-color: #fff3cd;">yellow</span>.`;
    introContainer.appendChild(mismatchNote);
  }

  // Append content and details to heading container
  details.appendChild(introContainer);
  headingContainer.appendChild(details);
}



 // Clear and populate the probability section
probabilityDiv.innerHTML = `
<button onclick="printSummary()" class="btn btn-primary btn-lg btn-block mrgn-tp-lg">Print your summary/Save as PDF</button>

   <h3>Resources</h3>
  <details><summary>Canada.ca</summary>
       <ul>
<li><a href="https://www.canada.ca/en/revenue-agency/services/tax/businesses/topics/corporations/corporation-income-tax-return/tax-implications-personal-services-business.html">Worker who performs services on behalf of their own corporation (personal services business)</a> </li>
<li><a href="https://test.canada.ca/cra-arc/subway/cppeirulings/index.html">Employment status: Employee or self-employed</a> </li>
<li><a href="https://www.canada.ca/en/revenue-agency/services/tax/canada-pension-plan-cpp-employment-insurance-ei-rulings/cpp-ei-explained.html">CPP/EI explained: Specific professions/industries</a> </li>
</ul></details>   
 
<details><summary>Infozone</summary>
     <ul>
<li><a href="https://infozone.omega.dce-eir.net/english/r1360144/000/005/mnu/pol/001_006-e.html">CPP/EI policy manual: How to determine where the contract was formed</a> </li>
<li><a href="https://infozone.omega.dce-eir.net/english/r1360144/000/005/mnu/pol/001_007-e.html">CPP/EI policy manual: Contract formed in a province or territory other than Quebec</a> </li>
<li><a href="https://infozone.omega.dce-eir.net/english/r1360144/000/005/mnu/pol/001_008-e.html">CPP/EI policy manual: Contract formed in the province of Quebec</a> </li>
<li><a href="https://infozone.omega.dce-eir.net/english/r1360144/000/005/mnu/pol/002-e.html">CPP/EI policy manual: Specific employments/workers</a> </li>	
</ul>    </details>   
   

 <p>
  <a href="#courtcases"
     class="wb-lbx btn btn-default btn-lg btn-block d-flex max-content"
     aria-controls="courtcases"
     role="button"
     data-wb-doaction='{
       "action": "ajax",
       "url": "https://test.canada.ca/cra-arc/payroll/emp-status/psb/project-folder/court-cases2.html#container",
       "container": "#courtcases .modal-body",
       "trigger": true
     }'>
    View court cases
  </a>
</p>

<!-- Modal for Court Cases -->
<section id="courtcases" class="mfp-hide modal-dialog modal-content overlay-def" role="dialog" aria-labelledby="modal-title">
  <header class="modal-header">
    <h2 class="modal-title" id="modal-title">View court cases</h2>
  </header>
  <div class="modal-body">
    <!-- AJAX content will be injected here -->
  </div>
</section>

<hr>

   <h3>Total – Indicators</h3>
<p >Totals are provided for <strong>information only</strong>. They are <strong>not</strong> provided to determine if the worker would have reasonably been considered an employee or self-employed if their corporation did not exist.</p>
  `;

  const worker = calculateSectionScores(workerData);
  const payer = calculateSectionScores(payerData);

  let totalQuestions = 0, workerCos = 0, payerCos = 0, workerNeutral = 0, payerNeutral = 0, workerCfs = 0, payerCfs = 0, workerInfo = 0, payerInfo = 0;

  const allSections = new Set([
    ...Object.keys(worker.cosScores),
    ...Object.keys(payer.cosScores)
  ]);

  for (const section of allSections) {
    const wTotal = worker.totalsScores[section] || 0;
    const pTotal = payer.totalsScores[section] || 0;
    const wCos = worker.cosScores[section] || 0;
    const pCos = payer.cosScores[section] || 0;
    const wNeutral = worker.neutralsScores[section] || 0;
    const pNeutral = payer.neutralsScores[section] || 0;
    const wCfs = worker.cfsScores[section] || 0;
    const pCfs = payer.cfsScores[section] || 0;
    const wInfo = worker.infoScores[section] || 0;
    const pInfo = payer.infoScores[section] || 0;	  

    if (wTotal > 0 || pTotal > 0) {
      totalQuestions += Math.max(wTotal, pTotal);
      workerCos += wCos;
      payerCos += pCos;
      workerNeutral += wNeutral;
      payerNeutral += pNeutral;
      workerCfs += wCfs;
      payerCfs += pCfs;
      workerInfo += wInfo;
      payerInfo += pInfo;    
    }
  }

const workerScoreText = (workerCos + workerCfs + workerNeutral + workerInfo) > 0
  ? `${getIndicatorIcon(1)} <abbr title="Contract of service">COS</abbr>: ${workerCos} of ${totalQuestions} <br>
     ${getIndicatorIcon(-1)} <abbr title="Contract for services">CFS</abbr>: ${workerCfs || 0} <br>
     ${getIndicatorIcon(0)} Neutral: ${workerNeutral || 0} <br>
     ${getIndicatorIcon(-2)} <abbr title="Information to help with the contract review">Info</abbr>: ${workerInfo || 0}`
  : 'N/A';

const payerScoreText = (payerCos + payerCfs + payerNeutral + payerInfo) > 0
  ? `${getIndicatorIcon(1)} <abbr title="Contract of service">COS</abbr>: ${payerCos} of ${totalQuestions} <br>
     ${getIndicatorIcon(-1)} <abbr title="Contract for services">CFS</abbr>: ${payerCfs || 0} <br>
     ${getIndicatorIcon(0)} Neutral: ${payerNeutral || 0} <br>
     ${getIndicatorIcon(-2)} <abbr title="Information to help with the contract review">Info</abbr>: ${payerInfo || 0}`
  : 'N/A';



  probabilityDiv.innerHTML += `
    <section class="panel panel-primary">
      <header class="panel-heading"><h5 class="panel-title">All section 5</h5></header>
      <div class="panel-body">
      <p><strong>Worker's answers</strong><br>
          <p>${workerScoreText}</p>
	   <hr>
     <p><strong>Payer's answers</strong><br>
       <p>${payerScoreText}</p>
      </div>
    </section>
  
    <hr>
    <h3>By section - Indicators</h3>
  `;

  for (const section of allSections) {
    const wTotal = worker.totalsScores[section] || 0;
    const pTotal = payer.totalsScores[section] || 0;

    if (wTotal > 0 || pTotal > 0) {

    const wScoreText = wTotal > 0
  ? `${getIndicatorIcon(1)} <abbr title="Contract of service">COS</abbr>: ${worker.cosScores[section]} of ${wTotal} <br>
   ${getIndicatorIcon(-1)}   <abbr title="Contract for services">CFS</abbr>: ${worker.cfsScores[section] || 0} <br>
 ${getIndicatorIcon(0)} Neutral: ${worker.neutralsScores[section] || 0} <br>
${getIndicatorIcon(-2)} <abbr title="Information to help with the contract review">Info</abbr>: ${worker.infoScores[section] || 0}
`
  : 'N/A';

const pScoreText = pTotal > 0
  ? `${getIndicatorIcon(1)} <abbr title="Contract of service">COS</abbr>: ${payer.cosScores[section]} of ${pTotal} <br>
   ${getIndicatorIcon(-1)}   <abbr title="Contract for services">CFS</abbr>: ${payer.cfsScores[section] || 0}<br>
${getIndicatorIcon(0)}  Neutral: ${payer.neutralsScores[section] || 0} <br>
${getIndicatorIcon(-2)} <abbr title="Information to help with the contract review">Info</abbr>: ${payer.infoScores[section] || 0} 
`
  : 'N/A';

      probabilityDiv.innerHTML += `
        <section class="panel panel-info">
          <header class="panel-heading"><h5 class="panel-title">${section}</h5></header>
          <div class="panel-body">
            <p><strong>Worker's answers</strong><br> ${wScoreText}</p>
	    <hr>
            <p><strong>Payer's answers</strong><br> ${pScoreText}</p>
          </div>
        </section>
      `;
    }
  }
 
}
</script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // Only fetch remote JSON if no file has been uploaded
  if (!window.workerCases && !window.payerCases) {
    fetch('https://test.canada.ca/cra-arc/payroll/emp-status/psb/June27forms.json')
      .then(response => {
        if (!response.ok) throw new Error('Failed to load JSON');
        return response.json();
      })
      .then(jsonData => {
        const workerMap = new Map();
        const payerMap = new Map();
        jsonData.forEach(entry => {
          const q441 = entry.answers.find(a => a.questionId === 441);
          const caseAns = entry.answers.find(a => a.questionId === 341);
          const caseNumber = caseAns && caseAns.answer ? caseAns.answer.trim() : "Unknown";
          if (q441 && q441.answer.includes("Worker whose corporation")) {
            workerMap.set(caseNumber, entry);
          } else if (q441 && q441.answer.includes("Payer who made payments")) {
            payerMap.set(caseNumber, entry);
          }
        });
        window.workerCases = workerMap;
        window.payerCases = payerMap;
        handleCaseSelection(workerMap, payerMap);
      })
      .catch(error => {
        console.error('Error loading JSON:', error);
      });
  }
});
</script>


<script>
function printSummary() {
  // Expand all <details> elements
  document.querySelectorAll("details").forEach(detail => {
    detail.setAttribute("open", true);
  });

  // Wait a moment to ensure rendering, then print
  setTimeout(() => {
    window.print();
  }, 100);
}
</script>

<script>
$(document).on("wb-ready.wb-lbx", function (event) {
  const lightboxBtn = document.querySelector('.wb-lbx');
  if (lightboxBtn) {
    console.log("Lightbox is ready");
    lightboxBtn.addEventListener('click', () => {
      console.log('Lightbox clicked');
    });
  } else {
    console.warn('Lightbox button still not found after wb-ready');
  }
});
</script>




</body>
</html>
